{% extends "base.html" %}

{% block title %}√âtape 2 - Choix de la Randonn√©e - RandoVanGo{% endblock %}

{% block page_content %}
<div class="main-container">
    <div class="page-header">
        <div class="hero-section">
            <img src="{{ url_for('static', filename='images/van-life-liberte.jpg') }}" alt="Planificateur Van Life"
                class="hero-background">
            <div class="hero-overlay"></div>
            <div class="hero-logo-container">
                <div class="hero-logo-white">
                    <img src="{{ url_for('static', filename='images/logo_randovango.png') }}" alt="RandoVanGo"
                        class="hero-logo-img">
                </div>
            </div>
            <div class="hero-content">
                <h1 class="hero-title">Planificateur RandoVanGo</h1>
                <p class="hero-subtitle">S√©lectionnez votre randonn√©e pr√©f√©r√©e</p>
            </div>
        </div>
    </div>

    <div class="planning-stepper">
        <div class="stepper-container">
            <div class="step completed">
                <div class="step-circle">‚úì</div>
                <div class="step-label">Ville</div>
            </div>
            <div class="step-line completed"></div>
            <div class="step active">
                <div class="step-circle">2</div>
                <div class="step-label">Randonn√©e</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">3</div>
                <div class="step-label">Nuit</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">4</div>
                <div class="step-label">Services</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">üìã</div>
                <div class="step-label">R√©sultat</div>
            </div>
        </div>
    </div>

    <div class="planning-content">
        <div class="planning-step">
            <div class="step-header">
                <h2>ü•æ Jour 1 : Choisissez votre randonn√©e</h2>
                <p>S√©lectionnez l'activit√© principale qui rythmera votre premi√®re journ√©e</p>
            </div>

            <!-- Filtres rapides -->
            <div class="hiking-filters">
                <div class="filter-group">
                    <label>Difficult√© :</label>
                    <button class="filter-btn active" data-filter="all">Toutes</button>
                    <button class="filter-btn" data-filter="facile">Facile</button>
                    <button class="filter-btn" data-filter="moyen">Moyen</button>
                    <button class="filter-btn" data-filter="difficile">Difficile</button>
                </div>
                <div class="filter-group">
                    <label>Dur√©e :</label>
                    <button class="filter-btn active" data-filter="all">Toutes</button>
                    <button class="filter-btn" data-filter="court">
                        < 2h</button>
                            <button class="filter-btn" data-filter="moyen">2-4h</button>
                            <button class="filter-btn" data-filter="long">> 4h</button>
                </div>
            </div>
            <!-- Carte interactive -->
            <div class="map-page-container" style="margin: 2rem 0;">
                <h3 class="map-title">Visualisation sur la carte</h3>
                <div id="map" style="height: 40vh; width: 100%; border-radius: 12px; box-shadow: 0 2px 8px #0002;">
                </div>
            </div>
            <!-- Liste des randonn√©es -->
            <div class="hiking-list" id="hikingList">
                <!-- Les randonn√©es seront charg√©es dynamiquement via l'API -->
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                    <p>Chargement des randonn√©es...</p>
                </div>
            </div>
            <style>
            .hiking-card.selected {
                border: 2px solid #51cf66;
                box-shadow: 0 0 12px #51cf6633;
                background: linear-gradient(90deg, #e6ffe6 0%, #f8fff8 100%);
            }
            </style>

            <!-- Option sans randonn√©e -->
            <div class="no-hiking-option" id="noHikingCard">
                <button class="btn btn-primary no-hiking-btn" onclick="selectNoHiking()">
                    Pas de rando aujourd'hui
                </button>
            </div>
        </div>

        <div class="planning-navigation">
            <div class="navigation-buttons">
                <a href="{{ url_for('step1') }}" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    Retour √† la ville
                </a>

                <a href="{{ url_for('step3') }}" class="btn btn-primary btn-large" id="nextStepBtn"
                    style="display: none;">
                    Valider la rando et continuer
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>

    </div> <!-- .planning-content -->
</div> <!-- .main-container -->
{% endblock %}

{% block scripts %}
<script>
    // ========================================
    // INITIALISATION ET CHARGEMENT DES RANDONN√âES
    // ========================================
    
    document.addEventListener('DOMContentLoaded', async function () {
        // R√©cup√©rer l'ID de la ville depuis le localStorage (d√©fini √† l'√©tape 1)
        const cityId = localStorage.getItem('selectedCityId');
        
        // Validation : v√©rifier qu'une ville a √©t√© s√©lectionn√©e √† l'√©tape 1
        if (!cityId) {
            alert('Aucune ville s√©lectionn√©e. Retour √† l\'√©tape 1.');
            window.location.href = "{{ url_for('step1') }}";
            return;
        }

        // ========================================
        // INITIALISATION DE LA CARTE LEAFLET
        // ========================================
        
        const mapElement = document.getElementById('map');
        let hikeMap = null;
        let hikingMarkers = [];  // Tableau pour stocker les marqueurs des randonn√©es

        if (mapElement && window.L && !mapElement._leaflet_id) {
            // Cr√©er la carte Leaflet avec une position par d√©faut (Bretagne)
            // La position sera mise √† jour avec les coordonn√©es r√©elles de la ville
            hikeMap = L.map('map').setView([48.4, -4.5], 12);

            // Ajouter les tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(hikeMap);
        }

        // ========================================
        // R√âCUP√âRATION DES COORDONN√âES DE LA VILLE
        // ========================================
        
        // R√©cup√©rer les coordonn√©es de la ville depuis l'API step1/cities
        // Note : pas besoin d'envoyer le token ici car on r√©cup√®re juste les coordonn√©es
        let cityCoords = null;
        try {
            const citiesResponse = await fetch('/api/step1/cities');
            if (citiesResponse.ok) {
                const cities = await citiesResponse.json();
                const selectedCity = cities.find(c => c.id == cityId);
                console.log('Ville s√©lectionn√©e:', selectedCity);
                if (selectedCity) {
                    // Stocker les coordonn√©es de la ville
                    cityCoords = { lat: selectedCity.latitude, lon: selectedCity.longitude, name: selectedCity.name };
                    
                    // Ajouter un marqueur bleu pour la ville sur la carte
                    if (hikeMap) {
                        // Cr√©er une ic√¥ne personnalis√©e bleue pour la ville
                        const cityIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style="background-color: #339af0; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4);"></div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        
                        // Ajouter le marqueur de la ville avec popup
                        const cityMarker = L.marker([cityCoords.lat, cityCoords.lon], { icon: cityIcon })
                            .addTo(hikeMap)
                            .bindPopup(`<b>üìç ${cityCoords.name}</b><br>Centre de recherche`);
                        
                        console.log('Marqueur ville ajout√©:', cityCoords);
                        // Centrer la carte sur la ville
                        hikeMap.setView([cityCoords.lat, cityCoords.lon], 12);
                    }
                }
            }
        } catch (error) {
            console.error('Erreur lors de la r√©cup√©ration de la ville:', error);
        }

        // ========================================
        // CHARGEMENT DES RANDONN√âES AVEC AUTHENTIFICATION JWT
        // ========================================
        
        // Note : Le token JWT est g√©r√© c√¥t√© serveur par Flask (session)
        // Flask r√©cup√®re le token depuis session['user']['token'] et le passe √† FastAPI
        // Si utilisateur connect√© : affichage selon le r√¥le (user = v√©rifi√©es uniquement, admin/contributor = toutes)
        // Si pas connect√© : affichage uniquement des randonn√©es v√©rifi√©es (comportement par d√©faut)
        
        // Charger les randonn√©es depuis l'API via le proxy Flask
        try {
            // Appel API pour r√©cup√©rer les randonn√©es dans un rayon de 5km autour de la ville
            // Le proxy Flask (/api/step2/hikes) ajoute automatiquement le token JWT depuis la session
            const response = await fetch(`/api/step2/hikes?city_id=${cityId}&distance_km=5`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error('Erreur lors du chargement des randonn√©es');
            }
            const hikes = await response.json();
            
            // Afficher les randonn√©es dans la liste
            displayHikes(hikes);
            
            // Ajouter les marqueurs verts sur la carte pour chaque randonn√©e
            if (hikeMap && hikes.length > 0) {
                hikes.forEach(hike => {
                    // Cr√©er une ic√¥ne personnalis√©e verte pour les randonn√©es
                    const hikeIcon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color: #51cf66; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    
                    // Ajouter le marqueur avec popup contenant les infos de la randonn√©e
                    const marker = L.marker([hike.start_latitude, hike.start_longitude], { icon: hikeIcon })
                        .addTo(hikeMap)
                        .bindPopup(`<b>ü•æ ${hike.name}</b><br>${hike.distance_km} km - ${hike.duration}h`);
                    
                    // Stocker le marqueur pour manipulation ult√©rieure
                    hikingMarkers.push({ marker, hike });
                });
            }
        } catch (error) {
            console.error('Erreur:', error);
            document.getElementById('hikingList').innerHTML = '<p style="text-align: center; color: red;">Erreur lors du chargement des randonn√©es</p>';
        }

        // Fonction pour afficher les randonn√©es
        function displayHikes(hikes) {
            const hikingList = document.getElementById('hikingList');
            hikingList.innerHTML = '';
            
            if (hikes.length === 0) {
                hikingList.innerHTML = '<p style="text-align: center;">Aucune randonn√©e disponible pour cette ville</p>';
                return;
            }
            
            hikes.forEach(hike => {
                const difficultyClass = hike.difficulte ? hike.difficulte.toLowerCase() : 'facile';
                const durationCategory = hike.duration < 2 ? 'court' : (hike.duration <= 4 ? 'moyen' : 'long');
                const verifiedBadge = hike.verifie ? '‚úÖ V√©rifi√©' : '‚ö†Ô∏è En attente';
                const statusClass = hike.verifie ? 'verified' : 'pending';
                const selectedHiking = localStorage.getItem('selectedHiking');
                const isSelected = selectedHiking && selectedHiking == hike.id;

                const card = document.createElement('div');
                card.className = 'hiking-card' + (isSelected ? ' selected' : '');
                card.setAttribute('data-difficulty', difficultyClass);
                card.setAttribute('data-duration', durationCategory);

                card.innerHTML = `
                    <div class="hiking-status">
                        <span class="status-badge ${statusClass}">${verifiedBadge}</span>
                    </div>
                    <div class="hiking-info">
                        <h3>${hike.name}</h3>
                        <p class="hiking-description">${hike.description || 'Randonn√©e sans description'}</p>
                        <div class="hiking-stats">
                            <span class="stat">
                                <i class="fas fa-clock"></i>
                                ${hike.duration}h
                            </span>
                            <span class="stat">
                                <i class="fas fa-route"></i>
                                ${hike.distance_km} km
                            </span>
                            <span class="stat">
                                <i class="fas fa-mountain"></i>
                                +${hike.elevation_gain_m}m
                            </span>
                            <span class="stat difficulty-${difficultyClass}">
                                <i class="fas fa-signal"></i>
                                ${hike.difficulte || 'N/A'}
                            </span>
                        </div>
                    </div>
                    <div class="hiking-actions">
                        <button class="btn btn-outline" onclick="showHikingMap(${hike.id}, ${hike.start_latitude}, ${hike.start_longitude})">
                            <i class="fas fa-map"></i>
                            Voir
                        </button>
                        <button class="btn btn-primary" onclick="selectHiking(${hike.id})">
                            Choisir
                        </button>
                    </div>
                `;

                hikingList.appendChild(card);
            });
        }

        // Fonction pour afficher une randonn√©e sur la carte
        window.showHikingMap = function(hikeId, lat, lon) {
            if (hikeMap) {
                hikeMap.setView([lat, lon], 14);
                // Ouvrir le popup du marqueur correspondant
                const markerData = hikingMarkers.find(m => m.hike.id === hikeId);
                if (markerData) {
                    markerData.marker.openPopup();
                }
            }
        };

        // Gestion des filtres
        let activeDifficultyFilter = 'all';
        let activeDurationFilter = 'all';
        
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function () {
                const group = this.parentElement;
                const filterType = group.querySelector('label').textContent.includes('Difficult√©') ? 'difficulty' : 'duration';
                const filterValue = this.getAttribute('data-filter');
                
                // Mettre √† jour le bouton actif dans le groupe
                group.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Mettre √† jour les filtres actifs
                if (filterType === 'difficulty') {
                    activeDifficultyFilter = filterValue;
                } else {
                    activeDurationFilter = filterValue;
                }
                
                // Appliquer les filtres
                applyFilters();
            });
        });
        
        // Fonction pour appliquer les filtres
        function applyFilters() {
            const hikingCards = document.querySelectorAll('.hiking-card');
            
            hikingCards.forEach(card => {
                const difficulty = card.getAttribute('data-difficulty');
                const duration = card.getAttribute('data-duration');
                
                // V√©rifier si la carte correspond aux filtres
                const matchesDifficulty = activeDifficultyFilter === 'all' || difficulty === activeDifficultyFilter;
                const matchesDuration = activeDurationFilter === 'all' || duration === activeDurationFilter;
                
                // Afficher ou masquer la carte
                if (matchesDifficulty && matchesDuration) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Gestion de la s√©lection de randonn√©e
        window.selectHiking = function (hikingId) {
            console.log('Randonn√©e s√©lectionn√©e:', hikingId);
            // Enregistrer la s√©lection dans le localStorage
            localStorage.setItem('selectedHiking', hikingId);
            // Marquer la randonn√©e s√©lectionn√©e visuellement
            document.querySelectorAll('.hiking-card').forEach(card => card.classList.remove('selected'));
            // Trouver la carte correspondante et ajouter la classe
            const cards = document.querySelectorAll('.hiking-card');
            cards.forEach(card => {
                const title = card.querySelector('h3');
                if (title && title.textContent && title.textContent.includes(hikingId)) {
                    card.classList.add('selected');
                } else if (card.querySelector('button.btn-primary') && card.querySelector('button.btn-primary').getAttribute('onclick') === `selectHiking(${hikingId})`) {
                    card.classList.add('selected');
                }
            });
            // Afficher le bouton "Continuer"
            document.getElementById('nextStepBtn').style.display = 'flex';
        };

        window.selectNoHiking = function () {
            console.log('Aucune randonn√©e s√©lectionn√©e');
            localStorage.setItem('selectedHiking', 'no-hiking');
            document.getElementById('nextStepBtn').style.display = 'flex';
        };

        window.showHikingMap = function (hikingId) {
            console.log('Afficher la carte de la randonn√©e:', hikingId);
            // TODO: Centrer la carte sur cette randonn√©e
        };
    });
</script>
{% endblock %}