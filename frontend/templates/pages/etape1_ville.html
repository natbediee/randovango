{% extends "base.html" %}

{% set current_step = 1 %}

{% block title %}√âtape 1 - Choix de la Ville - RandoVanGo{% endblock %}

{% block hero_subtitle %}Choisissez votre destination pour commencer l'aventure{% endblock %}

{% block planning_content %}
<div class="step-section">
    <div class="step-header">
        <h2>Planifiez votre s√©jour RandoVanGo</h2>
        <p>Choisissez votre destination et la dur√©e de votre aventure</p>
    </div>

    <!-- Recherche de ville -->

    <div class="search-container">
        <div class="search-input-group">
            <i class="fas fa-map-marker-alt"></i>
            <select id="citySelect" class="search-input">
                {% for ville in villes %}
                    <option value="{{ ville.id }}" 
                            data-lat="{{ ville.latitude }}" 
                            data-lon="{{ ville.longitude }}" 
                            data-name="{{ ville.name }}" 
                            data-dept="{{ ville.department or '' }}" 
                            data-country="{{ ville.country or '' }}" 
                            data-rando="{{ ville.stats.randonnees }}" 
                            data-spots="{{ ville.stats.spots }}" 
                            data-poi="{{ ville.stats.poi }}"
                            data-meteo='{{ ville.meteo | tojson }}'>
                        {{ ville.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Ville s√©lectionn√©e -->
    <div class="selected-city" id="selectedCity">
        <div class="card selected">
            <div class="city-header">
                <h3 id="cityName">{{ villes[0].name if villes else '' }}</h3>
                                <p id="cityDept">
                                    {{ villes[0].department if villes else '' }}
                                    {% if villes and villes[0].region %} - {{ villes[0].region }}{% endif %}
                                    {% if villes and villes[0].country %} - {{ villes[0].country }}{% endif %}
                                </p>
            </div>
            <div class="city-stats">
                <div class="stat-item">
                    <i class="fas fa-hiking"></i>
                    <span id="cityRando">{{ villes[0].stats.randonnees if villes else 0 }} randonn√©es</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-bed"></i>
                    <span id="citySpots">{{ villes[0].stats.spots if villes else 0 }} spots nuit</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-map-pin"></i>
                    <span id="cityServices">{{ villes[0].stats.poi if villes else 0 }} points d'int√©r√™t</span>
                </div>
            </div>
        </div>
    </div>

     <!-- Carte interactive -->
    <div class="map-page-container" style="margin: 2rem 0;">
        <h3 class="map-title">Visualisation sur la carte</h3>
        <div id="map" style="height: 40vh; width: 100%; border-radius: 12px; box-shadow: 0 2px 8px #0002;"></div>
    </div>
    <!-- M√©t√©o 7 jours -->
    <div class="weather-section">
        <h3 id="weatherTitle">üå§Ô∏è M√©t√©o √† {{ villes[0].name if villes else '' }} - Prochains jours</h3>
        <p>Consultez les pr√©visions locales pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="weather-grid" id="weatherGrid">
            {% if villes and villes[0].meteo %}
                {% for forecast in villes[0].meteo %}
                <div class="weather-day {% if forecast.weather_code < 45 %}good-weather{% elif forecast.weather_code <= 65 %}acceptable-weather{% else %}bad-weather{% endif %}">
                    <div class="day-name">{% if loop.index == 1 %}Aujourd'hui{% else %}Jour {{ loop.index }}{% endif %}</div>
                    <div class="weather-icon">
                        <img src="/static/images/wheather/{{ forecast.picto }}.png" alt="{{ forecast.picto }}" style="width: 100%; max-width: 80px; height: auto;">
                    </div>
                    <div class="temperatures">
                        <span class="temp-max">{{ forecast.temp_max|round|int }}¬∞</span>
                        <span class="temp-min">{{ forecast.temp_min|round|int }}¬∞</span>
                    </div>
                    <div class="weather-details">
                        {% if forecast.precipitation_sum > 0 %}
                        <div class="weather-info">
                            <i class="fas fa-tint"></i> {{ forecast.precipitation_sum|round(1) }} mm
                        </div>
                        {% endif %}
                        {% if forecast.wind_speed_max > 0 %}
                        <div class="weather-info">
                            <i class="fas fa-wind"></i> {{ forecast.wind_speed_max|round|int }} km/h
                        </div>
                        {% endif %}
                    </div>
                    <div class="weather-advice">
                        {% if forecast.picto == 'sun' %}
                            <i class="fas fa-check-circle"></i> Parfait pour randonner
                        {% elif forecast.picto == 'storm' %}
                            <i class="fas fa-exclamation-triangle"></i> √âviter les randos
                        {% elif forecast.picto == 'rain' or forecast.picto == 'snow' %}
                            <i class="fas fa-info-circle"></i> √âquipements conseill√©s
                        {% elif forecast.picto == 'fog' %}
                            <i class="fas fa-eye-slash"></i> Avec prudence
                        {% elif forecast.picto == 'cloud' %}
                            <i class="fas fa-cloud"></i> Conditions correctes
                        {% elif forecast.picto == 'indisponible' %}
                            <i class="fas fa-question-circle"></i> M√©t√©o indisponible
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>Aucune donn√©e m√©t√©o disponible</p>
            {% endif %}
        </div>
    </div>

    <!-- Dur√©e du s√©jour -->
    <div class="duration-section">
        <h3>üìÖ Combien de jours voulez-vous rester ?</h3>
        <p>Consultez la m√©t√©o ci-dessus pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="duration-options">
            <div class="duration-card" data-days="1">
                <div class="duration-number">1</div>
                <div class="duration-label">jour</div>
                <div class="duration-desc">Escapade express</div>
            </div>
            <div class="duration-card active" data-days="2">
                <div class="duration-number">2</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Week-end parfait</div>
            </div>
            <div class="duration-card" data-days="3">
                <div class="duration-number">3</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Long week-end</div>
            </div>
            <div class="duration-card" data-days="7">
                <div class="duration-number">7</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Semaine compl√®te</div>
            </div>
            <div class="duration-card" data-days="custom">
                <div class="duration-number">
                    <input type="number" id="customDays" min="1" max="30" placeholder="?">
                </div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Dur√©e personnalis√©e</div>
            </div>
        </div>
    </div>
</div>

<script>
    // Met √† jour la fiche ville et la carte √† la s√©lection
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Script d√©marr√©');
        const select = document.getElementById('citySelect');
        if (!select) {
            console.error('‚ùå citySelect non trouv√©');
            return;
        }
        console.log('‚úÖ citySelect trouv√©');
        
        // Variables locales pour la carte et le marker
        let cityMap = null;
        let cityMarker = null;
        
        // Initialisation de la carte Leaflet sur la premi√®re ville
        const mapElement = document.getElementById('map');
        if (window.L && mapElement && !mapElement._leaflet_id) {
            console.log('üó∫Ô∏è Initialisation de la carte');
            const opt = select.options[select.selectedIndex];
            const lat = parseFloat(opt.getAttribute('data-lat'));
            const lon = parseFloat(opt.getAttribute('data-lon'));
            console.log('üìç Position initiale:', lat, lon);
            
            console.log('üÜï Cr√©ation de la carte');
            cityMap = L.map('map').setView([lat, lon], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(cityMap);
            
            // Ajoute le marker initial
            cityMarker = L.marker([lat, lon]).addTo(cityMap);
            console.log('‚úÖ Carte initialis√©e');
        } else {
            console.error('‚ùå Leaflet ou map div non trouv√©, ou carte d√©j√† initialis√©e');
        }
        
        select.addEventListener('change', function() {
            console.log('üîÑ Changement de ville d√©tect√©');
            const opt = select.options[select.selectedIndex];
            const cityName = opt.getAttribute('data-name');
            console.log('üìç Nouvelle ville:', cityName);
            document.getElementById('cityName').textContent = cityName;
            let dept = opt.getAttribute('data-dept') || '';
            let country = opt.getAttribute('data-country') || '';
            document.getElementById('cityDept').textContent = dept + (country ? ' - ' + country : '');
            document.getElementById('cityRando').textContent = opt.getAttribute('data-rando') + ' randonn√©es';
            document.getElementById('citySpots').textContent = opt.getAttribute('data-spots') + ' spots nuit';
            document.getElementById('cityServices').textContent = opt.getAttribute('data-poi') + " points d'int√©r√™t";
            
            // Mise √† jour du titre m√©t√©o
            document.getElementById('weatherTitle').textContent = 'üå§Ô∏è M√©t√©o √† ' + cityName + ' - Prochains jours';
            
            // Mise √† jour des pr√©visions m√©t√©o
            let meteoData = [];
            try {
                const meteoStr = opt.getAttribute('data-meteo');
                console.log('üìä Donn√©es m√©t√©o brutes:', meteoStr);
                meteoData = JSON.parse(meteoStr);
                console.log('‚úÖ M√©t√©o pars√©e:', meteoData.length, 'jours');
            } catch (e) {
                console.error('‚ùå Erreur parsing m√©t√©o:', e.message);
                console.error('‚ùå Donn√©es brutes:', opt.getAttribute('data-meteo'));
            }
            const weatherGrid = document.getElementById('weatherGrid');
            weatherGrid.innerHTML = '';
            
            if (meteoData && meteoData.length > 0) {
                const daysOfWeek = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const months = ['janv', 'f√©vr', 'mars', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sept', 'oct', 'nov', 'd√©c'];
                meteoData.forEach((forecast, index) => {
                    const date = new Date(forecast.date);
                    const dayOfWeek = daysOfWeek[date.getDay()];
                    const dayNum = date.getDate();
                    const month = months[date.getMonth()];
                    const dayName = index === 0 ? "Aujourd'hui" : `${dayOfWeek} ${dayNum} ${month}`;
                    
                    // Application des classes CSS selon le weather_code
                    let weatherClass = '';
                    if (forecast.weather_code < 45) {
                        weatherClass = 'good-weather';
                    } else if (forecast.weather_code <= 65) {
                        weatherClass = 'acceptable-weather';
                    } else {
                        weatherClass = 'bad-weather';
                    }
                    
                    // Message de conseil selon le picto
                    let adviceMessage = '';
                    let adviceIcon = '';
                    if (forecast.picto === 'sun') {
                        adviceIcon = '<i class="fas fa-check-circle"></i>';
                        adviceMessage = 'Parfait pour randonner';
                    } else if (forecast.picto === 'storm') {
                        adviceIcon = '<i class="fas fa-exclamation-triangle"></i>';
                        adviceMessage = '√âviter les randos';
                    } else if (forecast.picto === 'rain' || forecast.picto === 'snow') {
                        adviceIcon = '<i class="fas fa-info-circle"></i>';
                        adviceMessage = '√âquipements conseill√©s';
                    } else if (forecast.picto === 'fog') {
                        adviceIcon = '<i class="fas fa-eye-slash"></i>';
                        adviceMessage = 'Avec prudence';
                    } else if (forecast.picto === 'cloud') {
                        adviceIcon = '<i class="fas fa-cloud"></i>';
                        adviceMessage = 'Conditions correctes';
                    } else if (forecast.picto === 'indisponible') {
                        adviceIcon = '<i class="fas fa-question-circle"></i>';
                        adviceMessage = 'M√©t√©o indisponible';
                    }
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'weather-day ' + weatherClass;
                    dayDiv.innerHTML = `
                        <div class="day-name">${dayName}</div>
                        <div class="weather-icon">
                            <img src="/static/images/wheather/${forecast.picto}.png" alt="${forecast.picto}" style="width: 100%; max-width: 80px; height: auto;">
                        </div>
                        <div class="temperatures">
                            <span class="temp-max">${Math.round(forecast.temp_max)}¬∞</span>
                            <span class="temp-min">${Math.round(forecast.temp_min)}¬∞</span>
                        </div>
                        <div class="weather-details">
                            ${forecast.precipitation_sum > 0 ? `<div class="weather-info"><i class="fas fa-tint"></i> ${forecast.precipitation_sum.toFixed(1)} mm</div>` : ''}
                            ${forecast.wind_speed_max > 0 ? `<div class="weather-info"><i class="fas fa-wind"></i> ${Math.round(forecast.wind_speed_max)} km/h</div>` : ''}
                        </div>
                        <div class="weather-advice">
                            ${adviceIcon} ${adviceMessage}
                        </div>
                    `;
                    weatherGrid.appendChild(dayDiv);
                });
            } else {
                weatherGrid.innerHTML = '<p>Aucune donn√©e m√©t√©o disponible</p>';
            }
            
            // Centrer la carte sur la nouvelle ville et d√©placer le marker
            console.log('üîç cityMap existe?', !!cityMap, 'Leaflet existe?', !!window.L);
            if (cityMap && window.L) {
                const lat = parseFloat(opt.getAttribute('data-lat'));
                const lon = parseFloat(opt.getAttribute('data-lon'));
                console.log('üó∫Ô∏è Coordonn√©es extraites:', lat, lon, 'valides?', !isNaN(lat) && !isNaN(lon));
                if (!isNaN(lat) && !isNaN(lon)) {
                    console.log('üó∫Ô∏è Mise √† jour de la carte vers:', lat, lon);
                    // D√©placer la vue de la carte
                    cityMap.setView([lat, lon], 12);
                    console.log('‚úÖ setView effectu√©');
                    // Supprime l'ancien marker s'il existe
                    if (cityMarker) {
                        console.log('üóëÔ∏è Suppression ancien marker');
                        cityMap.removeLayer(cityMarker);
                    }
                    // Ajoute le nouveau marker
                    console.log('üìç Ajout nouveau marker');
                    cityMarker = L.marker([lat, lon]).addTo(cityMap);
                    console.log('‚úÖ Carte mise √† jour compl√®tement');
                } else {
                    console.error('‚ùå Coordonn√©es invalides');
                }
            } else {
                console.error('‚ùå Carte non disponible - cityMap:', !!cityMap, 'Leaflet:', !!window.L);
            }
        });
    });
</script>

{% endblock %}

{% block navigation %}
<div class="navigation-buttons navigation-right">
    <a href="{{ url_for('etape2') }}" class="btn btn-primary btn-large">
        Planifier ces 2 jours
        <i class="fas fa-arrow-right"></i>
    </a>
</div>
{% endblock %}