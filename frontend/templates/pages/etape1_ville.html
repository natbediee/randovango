{% extends "base.html" %}

{% set current_step = 1 %}

{% block title %}Ã‰tape 1 - Choix de la Ville - RandoVanGo{% endblock %}

{% block hero_subtitle %}Choisissez votre destination pour commencer l'aventure{% endblock %}

{% block planning_content %}
<div class="step-section">
    <div class="step-header">
        <h2>Planifiez votre sÃ©jour RandoVanGo</h2>
        <p>Choisissez votre destination et la durÃ©e de votre aventure</p>
    </div>

    <!-- Recherche de ville -->
    <div class="search-container">
        <div class="search-input-group">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" id="citySearch" placeholder="Rechercher une ville... (ex: Plougonvelin)" class="search-input" value="Plougonvelin">
            <button class="btn btn-primary" id="searchBtn">
                Rechercher
            </button>
        </div>
    
    </div>

    <!-- Ville sÃ©lectionnÃ©e -->
    <div class="selected-city" id="selectedCity">
        <div class="card selected">
            <div class="city-header">
                <h3>Plougonvelin</h3>
                <p>FinistÃ¨re, Bretagne - France</p>
            </div>
            <div class="city-stats">
                <div class="stat-item">
                    <i class="fas fa-hiking"></i>
                    <span>11 randonnÃ©es</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-bed"></i>
                    <span>23 spots nuit</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-map-pin"></i>
                    <span>156 points d'intÃ©rÃªt</span>
                </div>
            </div>
        </div>
    </div>

    <!-- MÃ©tÃ©o 7 jours -->
    <div class="weather-section">
        <h3>ğŸŒ¤ï¸ MÃ©tÃ©o Ã  Plougonvelin - Prochains jours</h3>
        <p>Consultez les prÃ©visions locales pour choisir la durÃ©e idÃ©ale de votre sÃ©jour</p>
        <div class="weather-grid">
            <div class="weather-day good-weather">
                <div class="day-name">Aujourd'hui</div>
                <div class="weather-icon">â˜€ï¸</div>
                <div class="temperatures">
                    <span class="temp-max">18Â°</span>
                    <span class="temp-min">12Â°</span>
                </div>
                <div class="weather-desc">Parfait pour randonner</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Demain</div>
                <div class="weather-icon">â›…</div>
                <div class="temperatures">
                    <span class="temp-max">16Â°</span>
                    <span class="temp-min">10Â°</span>
                </div>
                <div class="weather-desc">Correct</div>
            </div>
            
            <div class="weather-day bad-weather">
                <div class="day-name">Mercredi</div>
                <div class="weather-icon">ğŸŒ§ï¸</div>
                <div class="temperatures">
                    <span class="temp-max">14Â°</span>
                    <span class="temp-min">8Â°</span>
                </div>
                <div class="weather-desc">Ã‰viter les randos</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Jeudi</div>
                <div class="weather-icon">â˜€ï¸</div>
                <div class="temperatures">
                    <span class="temp-max">19Â°</span>
                    <span class="temp-min">13Â°</span>
                </div>
                <div class="weather-desc">IdÃ©al</div>
            </div>
            
            <div class="weather-day">
                <div class="day-name">Vendredi</div>
                <div class="weather-icon">â›…</div>
                <div class="temperatures">
                    <span class="temp-max">17Â°</span>
                    <span class="temp-min">11Â°</span>
                </div>
                <div class="weather-desc">Variable</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Samedi</div>
                <div class="weather-icon">â˜€ï¸</div>
                <div class="temperatures">
                    <span class="temp-max">20Â°</span>
                    <span class="temp-min">14Â°</span>
                </div>
                <div class="weather-desc">Parfait</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Dimanche</div>
                <div class="weather-icon">ğŸŒ¤ï¸</div>
                <div class="temperatures">
                    <span class="temp-max">18Â°</span>
                    <span class="temp-min">12Â°</span>
                </div>
                <div class="weather-desc">TrÃ¨s bien</div>
            </div>
        </div>
    </div>

    <!-- DurÃ©e du sÃ©jour -->
    <div class="duration-section">
        <h3>ğŸ“… Combien de jours voulez-vous rester ?</h3>
        <p>Consultez la mÃ©tÃ©o ci-dessus pour choisir la durÃ©e idÃ©ale de votre sÃ©jour</p>
        <div class="duration-options">
            <div class="duration-card" data-days="1">
                <div class="duration-number">1</div>
                <div class="duration-label">jour</div>
                <div class="duration-desc">Escapade express</div>
            </div>
            <div class="duration-card active" data-days="2">
                <div class="duration-number">2</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Week-end parfait</div>
            </div>
            <div class="duration-card" data-days="3">
                <div class="duration-number">3</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Long week-end</div>
            </div>
            <div class="duration-card" data-days="7">
                <div class="duration-number">7</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Semaine complÃ¨te</div>
            </div>
            <div class="duration-card" data-days="custom">
                <div class="duration-number">
                    <input type="number" id="customDays" min="1" max="30" placeholder="?">
                </div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">DurÃ©e personnalisÃ©e</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block navigation %}
<div class="navigation-buttons navigation-right">
    <a href="{{ url_for('planificateur_etape2') }}" class="btn btn-primary btn-large">
        Planifier ces 2 jours
        <i class="fas fa-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// JavaScript minimal pour la recherche de ville
document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('searchBtn');
    const citySearch = document.getElementById('citySearch');
    
    searchBtn.addEventListener('click', function() {
        const cityName = citySearch.value || 'Plougonvelin';
        // Ici on appellerait l'API FastAPI pour rÃ©cupÃ©rer les donnÃ©es de la ville
        console.log('Recherche de:', cityName);
        
        // Simulation de mise Ã  jour (sera remplacÃ© par l'API)
        document.querySelector('.selected-city h3').textContent = 'ğŸ“ ' + cityName;
    });
    
    // GÃ©olocalisation
    document.getElementById('geolocateBtn').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                console.log('Position:', position.coords.latitude, position.coords.longitude);
                // Ici on appellerait l'API pour rÃ©cupÃ©rer la ville la plus proche
                alert('GÃ©olocalisation rÃ©ussie! (FonctionnalitÃ© Ã  implÃ©menter)');
            });
        } else {
            alert('GÃ©olocalisation non supportÃ©e par ce navigateur');
        }
    });

    // SÃ©lection de durÃ©e
    document.querySelectorAll('.duration-card').forEach(card => {
        card.addEventListener('click', function() {
            // Retirer la classe active de toutes les cartes
            document.querySelectorAll('.duration-card').forEach(c => c.classList.remove('active'));
            // Ajouter la classe active Ã  la carte cliquÃ©e
            this.classList.add('active');
            
            const days = this.getAttribute('data-days');
            if (days === 'custom') {
                const input = this.querySelector('#customDays');
                if (input) {
                    input.focus();
                }
            }
            
            // Sauvegarder la sÃ©lection
            if (days !== 'custom') {
                localStorage.setItem('trip_duration', days);
                updateNavigationText(days);
            }
        });
    });

    // Gestion de la durÃ©e personnalisÃ©e
    const customInput = document.getElementById('customDays');
    if (customInput) {
        customInput.addEventListener('input', function() {
            const days = parseInt(this.value);
            if (days >= 1 && days <= 30) {
                localStorage.setItem('trip_duration', days);
                updateNavigationText(days);
            }
        });
    }

    function updateNavigationText(days) {
        const navigationBtn = document.querySelector('.navigation-buttons .btn-primary');
        if (navigationBtn) {
            if (days == 1) {
                navigationBtn.innerHTML = 'Planifier cette journÃ©e <i class="fas fa-arrow-right"></i>';
            } else {
                navigationBtn.innerHTML = `Planifier ces ${days} jours <i class="fas fa-arrow-right"></i>`;
            }
        }
    }

    // Interaction mÃ©tÃ©o pour aider la dÃ©cision
    document.querySelectorAll('.weather-day').forEach((day, index) => {
        day.addEventListener('click', function() {
            const dayName = this.querySelector('.day-name').textContent;
            const isGoodWeather = this.classList.contains('good-weather');
            const isBadWeather = this.classList.contains('bad-weather');
            
            let suggestion = '';
            if (isGoodWeather) {
                suggestion = `${dayName} : Parfait pour une randonnÃ©e ! ğŸ¥¾`;
            } else if (isBadWeather) {
                suggestion = `${dayName} : Jour de pluie, idÃ©al pour visiter des sites couverts ou se reposer ğŸ›ï¸`;
            } else {
                suggestion = `${dayName} : Temps variable, activitÃ©s flexibles recommandÃ©es ğŸ¤”`;
            }
            
            // SuggÃ©rer une durÃ©e basÃ©e sur la mÃ©tÃ©o
            if (index <= 1 && !isBadWeather) {
                suggestion += '\nğŸ’¡ Suggestion: Profitez de ces beaux jours pour un court sÃ©jour (1-2 jours)';
            } else if (index >= 5 && isGoodWeather) {
                suggestion += '\nğŸ’¡ Suggestion: Beau temps en fin de semaine, parfait pour un long sÃ©jour !';
            }
            
            // Afficher la suggestion
            const existingTooltip = document.querySelector('.weather-tooltip');
            if (existingTooltip) existingTooltip.remove();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'weather-tooltip';
            tooltip.textContent = suggestion;
            tooltip.style.cssText = `
                position: fixed;
                background: var(--blue);
                color: white;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: var(--shadow-hover);
                z-index: 1000;
                max-width: 300px;
                font-size: 0.9rem;
                white-space: pre-line;
            `;
            
            document.body.appendChild(tooltip);
            
            const rect = this.getBoundingClientRect();
            tooltip.style.left = Math.min(rect.left, window.innerWidth - tooltip.offsetWidth - 20) + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
            
            setTimeout(() => tooltip.remove(), 3000);
        });
    });

    // Initialiser avec la sÃ©lection par dÃ©faut (2 jours)
    localStorage.setItem('trip_duration', '2');
    updateNavigationText(2);
});
</script>
{% endblock %}