{% extends "base.html" %}

{% set current_step = 1 %}

{% block title %}√âtape 1 - Choix de la Ville - RandoVanGo{% endblock %}

{% block hero_subtitle %}Choisissez votre destination pour commencer l'aventure{% endblock %}

{% block planning_content %}
<div class="step-section">
    <div class="step-header">
        <h2>Planifiez votre s√©jour RandoVanGo</h2>
        <p>Choisissez votre destination et la dur√©e de votre aventure</p>
    </div>

    <!-- Recherche de ville -->

    <div class="search-container">
        <div class="search-input-group">
            <i class="fas fa-map-marker-alt"></i>
            <select id="citySelect" class="search-input">
                {% for ville in villes %}
                    <option value="{{ ville.id }}" 
                            data-lat="{{ ville.latitude }}" 
                            data-lon="{{ ville.longitude }}" 
                            data-name="{{ ville.name }}" 
                            data-dept="{{ ville.department or '' }}" 
                            data-country="{{ ville.country or '' }}" 
                            data-rando="{{ ville.stats.randonnees }}" 
                            data-spots="{{ ville.stats.spots }}" 
                            data-poi="{{ ville.stats.poi }}"
                            data-meteo='{{ ville.meteo | tojson }}'>
                        {{ ville.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Ville s√©lectionn√©e -->
    <div class="selected-city" id="selectedCity">
        <div class="card selected">
            <div class="city-header">
                <h3 id="cityName">{{ villes[0].name if villes else '' }}</h3>
                                <p id="cityDept">
                                    {{ villes[0].department if villes else '' }}
                                    {% if villes and villes[0].region %} - {{ villes[0].region }}{% endif %}
                                    {% if villes and villes[0].country %} - {{ villes[0].country }}{% endif %}
                                </p>
            </div>
            <div class="city-stats">
                <div class="stat-item">
                    <i class="fas fa-hiking"></i>
                    <span id="cityRando">{{ villes[0].stats.randonnees if villes else 0 }} randonn√©es</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-bed"></i>
                    <span id="citySpots">{{ villes[0].stats.spots if villes else 0 }} spots nuit</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-map-pin"></i>
                    <span id="cityServices">{{ villes[0].stats.poi if villes else 0 }} points d'int√©r√™t</span>
                </div>
            </div>
        </div>
    </div>

     <!-- Carte interactive -->
    <div class="map-page-container" style="margin: 2rem 0;">
        <h3 class="map-title">Visualisation sur la carte</h3>
        <div id="map" style="height: 40vh; width: 100%; border-radius: 12px; box-shadow: 0 2px 8px #0002;"></div>
    </div>
    <!-- M√©t√©o 7 jours -->
    <div class="weather-section">
        <h3 id="weatherTitle">üå§Ô∏è M√©t√©o √† {{ villes[0].name if villes else '' }} - Prochains jours</h3>
        <p>Consultez les pr√©visions locales pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="weather-grid" id="weatherGrid">
            {% if villes and villes[0].meteo %}
                {% for forecast in villes[0].meteo %}
                <div class="weather-day {% if forecast.weather_code < 45 %}good-weather{% elif forecast.weather_code <= 65 %}acceptable-weather{% else %}bad-weather{% endif %}">
                    <div class="day-name">{% if loop.index == 1 %}Aujourd'hui{% else %}Jour {{ loop.index }}{% endif %}</div>
                    <div class="weather-icon">
                        <img src="/static/images/wheather/{{ forecast.picto }}.png" alt="{{ forecast.picto }}" style="width: 100%; max-width: 80px; height: auto;">
                    </div>
                    <div class="temperatures">
                        <span class="temp-max">{{ forecast.temp_max|round|int }}¬∞</span>
                        <span class="temp-min">{{ forecast.temp_min|round|int }}¬∞</span>
                    </div>
                    <div class="weather-details">
                        {% if forecast.precipitation_sum > 0 %}
                        <div class="weather-info">
                            <i class="fas fa-tint"></i> {{ forecast.precipitation_sum|round(1) }} mm
                        </div>
                        {% endif %}
                        {% if forecast.wind_speed_max > 0 %}
                        <div class="weather-info">
                            <i class="fas fa-wind"></i> {{ forecast.wind_speed_max|round|int }} km/h
                        </div>
                        {% endif %}
                    </div>
                    <div class="weather-advice">
                        {% if forecast.picto == 'sun' %}
                            <i class="fas fa-check-circle"></i> Parfait pour randonner
                        {% elif forecast.picto == 'storm' %}
                            <i class="fas fa-exclamation-triangle"></i> √âviter les randos
                        {% elif forecast.picto == 'rain' or forecast.picto == 'snow' %}
                            <i class="fas fa-info-circle"></i> √âquipements conseill√©s
                        {% elif forecast.picto == 'fog' %}
                            <i class="fas fa-eye-slash"></i> Avec prudence
                        {% elif forecast.picto == 'cloud' %}
                            <i class="fas fa-cloud"></i> Conditions correctes
                        {% elif forecast.picto == 'indisponible' %}
                            <i class="fas fa-question-circle"></i> M√©t√©o indisponible
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>Aucune donn√©e m√©t√©o disponible</p>
            {% endif %}
        </div>
    </div>

    <!-- Dur√©e du s√©jour -->
    <div class="duration-section">
        <h3>üìÖ Combien de jours voulez-vous rester ?</h3>
        <p>Consultez la m√©t√©o ci-dessus pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="duration-options">
            <div class="duration-card" data-days="1">
                <div class="duration-number">1</div>
                <div class="duration-label">jour</div>
                <div class="duration-desc">Escapade express</div>
            </div>
            <div class="duration-card active" data-days="2">
                <div class="duration-number">2</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Week-end parfait</div>
            </div>
            <div class="duration-card" data-days="3">
                <div class="duration-number">3</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Long week-end</div>
            </div>
            <div class="duration-card" data-days="7">
                <div class="duration-number">7</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Semaine compl√®te</div>
            </div>
            <div class="duration-card" data-days="custom">
                <div class="duration-number">
                    <input type="number" id="customDays" min="1" max="30" placeholder="?">
                </div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Dur√©e personnalis√©e</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block navigation %}
<div class="navigation-buttons navigation-right">
    <button id="planButton" class="btn btn-primary btn-large">
        Planifier ces 2 jours
        <i class="fas fa-arrow-right"></i>
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Gestion dynamique de la s√©lection de ville avec carte et m√©t√©o
    document.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('citySelect');
        if (!select) return;
        
        // Variables pour la carte Leaflet
        let cityMap = null;
        let cityMarker = null;
        
        // Initialisation de la carte sur la premi√®re ville
        const mapElement = document.getElementById('map');
        if (window.L && mapElement && !mapElement._leaflet_id) {
            const opt = select.options[select.selectedIndex];
            const lat = parseFloat(opt.getAttribute('data-lat'));
            const lon = parseFloat(opt.getAttribute('data-lon'));
            
            cityMap = L.map('map').setView([lat, lon], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(cityMap);
            cityMarker = L.marker([lat, lon]).addTo(cityMap);
        }
        
        // √âcouter le changement de ville
        select.addEventListener('change', function() {
            const opt = select.options[select.selectedIndex];
            const cityName = opt.getAttribute('data-name');
            
            // Mise √† jour des informations de la ville
            document.getElementById('cityName').textContent = cityName;
            const dept = opt.getAttribute('data-dept') || '';
            const country = opt.getAttribute('data-country') || '';
            document.getElementById('cityDept').textContent = dept + (country ? ' - ' + country : '');
            document.getElementById('cityRando').textContent = opt.getAttribute('data-rando') + ' randonn√©es';
            document.getElementById('citySpots').textContent = opt.getAttribute('data-spots') + ' spots nuit';
            document.getElementById('cityServices').textContent = opt.getAttribute('data-poi') + " points d'int√©r√™t";
            document.getElementById('weatherTitle').textContent = 'üå§Ô∏è M√©t√©o √† ' + cityName + ' - Prochains jours';
            
            // Mise √† jour de la m√©t√©o
            updateWeatherDisplay(opt);
            
            // Mise √† jour de la carte
            updateMap(opt);
        });
        
        // Fonction pour mettre √† jour l'affichage m√©t√©o
        function updateWeatherDisplay(option) {
            let meteoData = [];
            try {
                meteoData = JSON.parse(option.getAttribute('data-meteo'));
            } catch (e) {
                console.error('Erreur parsing m√©t√©o:', e.message);
            }
            
            const weatherGrid = document.getElementById('weatherGrid');
            weatherGrid.innerHTML = '';
            
            if (meteoData && meteoData.length > 0) {
                const daysOfWeek = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const months = ['janv', 'f√©vr', 'mars', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sept', 'oct', 'nov', 'd√©c'];
                
                meteoData.forEach((forecast, index) => {
                    const date = new Date(forecast.date);
                    const dayName = index === 0 ? "Aujourd'hui" : 
                        `${daysOfWeek[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
                    
                    // Classe CSS selon le weather_code
                    let weatherClass = 'good-weather';
                    if (forecast.weather_code >= 45 && forecast.weather_code <= 65) {
                        weatherClass = 'acceptable-weather';
                    } else if (forecast.weather_code > 65) {
                        weatherClass = 'bad-weather';
                    }
                    
                    // Message de conseil selon le type de temps
                    const adviceMap = {
                        'sun': { icon: 'fa-check-circle', text: 'Parfait pour randonner' },
                        'storm': { icon: 'fa-exclamation-triangle', text: '√âviter les randos' },
                        'rain': { icon: 'fa-info-circle', text: '√âquipements conseill√©s' },
                        'snow': { icon: 'fa-info-circle', text: '√âquipements conseill√©s' },
                        'fog': { icon: 'fa-eye-slash', text: 'Avec prudence' },
                        'cloud': { icon: 'fa-cloud', text: 'Conditions correctes' },
                        'indisponible': { icon: 'fa-question-circle', text: 'M√©t√©o indisponible' }
                    };
                    const advice = adviceMap[forecast.picto] || adviceMap['indisponible'];
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'weather-day ' + weatherClass;
                    dayDiv.innerHTML = `
                        <div class="day-name">${dayName}</div>
                        <div class="weather-icon">
                            <img src="/static/images/wheather/${forecast.picto}.png" alt="${forecast.picto}" 
                                 style="width: 100%; max-width: 80px; height: auto;">
                        </div>
                        <div class="temperatures">
                            <span class="temp-max">${Math.round(forecast.temp_max)}¬∞</span>
                            <span class="temp-min">${Math.round(forecast.temp_min)}¬∞</span>
                        </div>
                        <div class="weather-details">
                            ${forecast.precipitation_sum > 0 ? 
                                `<div class="weather-info"><i class="fas fa-tint"></i> ${forecast.precipitation_sum.toFixed(1)} mm</div>` : ''}
                            ${forecast.wind_speed_max > 0 ? 
                                `<div class="weather-info"><i class="fas fa-wind"></i> ${Math.round(forecast.wind_speed_max)} km/h</div>` : ''}
                        </div>
                        <div class="weather-advice">
                            <i class="fas ${advice.icon}"></i> ${advice.text}
                        </div>
                    `;
                    weatherGrid.appendChild(dayDiv);
                });
            } else {
                weatherGrid.innerHTML = '<p>Aucune donn√©e m√©t√©o disponible</p>';
            }
        }
        
        // Fonction pour mettre √† jour la carte
        function updateMap(option) {
            if (!cityMap || !window.L) return;
            
            const lat = parseFloat(option.getAttribute('data-lat'));
            const lon = parseFloat(option.getAttribute('data-lon'));
            
            if (!isNaN(lat) && !isNaN(lon)) {
                cityMap.setView([lat, lon], 12);
                if (cityMarker) {
                    cityMap.removeLayer(cityMarker);
                }
                cityMarker = L.marker([lat, lon]).addTo(cityMap);
            }
        }
        
        // Gestion de la s√©lection de la dur√©e
        let selectedDays = 2; // Par d√©faut 2 jours
        const durationCards = document.querySelectorAll('.duration-card');
        const planButton = document.getElementById('planButton');
        
        durationCards.forEach(card => {
            card.addEventListener('click', function() {
                // Retirer la classe active de toutes les cards
                durationCards.forEach(c => c.classList.remove('active'));
                
                // Ajouter la classe active √† la card cliqu√©e
                this.classList.add('active');
                
                // R√©cup√©rer le nombre de jours
                const days = this.getAttribute('data-days');
                
                if (days === 'custom') {
                    const customInput = document.getElementById('customDays');
                    customInput.focus();
                    customInput.addEventListener('input', function() {
                        selectedDays = parseInt(this.value) || 2;
                        updatePlanButton();
                    });
                } else {
                    selectedDays = parseInt(days);
                    updatePlanButton();
                }
            });
        });
        
        // Mettre √† jour le texte du bouton
        function updatePlanButton() {
            if (planButton) {
                const dayText = selectedDays === 1 ? 'jour' : 'jours';
                planButton.innerHTML = `Planifier ces ${selectedDays} ${dayText} <i class="fas fa-arrow-right"></i>`;
            }
        }
        
        // Appel de l'API create_plan au clic sur le bouton
        if (planButton) {
            planButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const selectedOption = select.options[select.selectedIndex];
                const villeId = selectedOption.value;
                
                // Stocker en localStorage
                localStorage.setItem('selectedVilleId', villeId);
                localStorage.setItem('selectedDays', selectedDays);
                
                // Appeler l'API create_plan
                createPlan(villeId, selectedDays);
            });
        }
        
        // Fonction pour appeler l'API create_plan
        async function createPlan(villeId, days) {
            try {
                planButton.disabled = true;
                planButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation du plan...';

                // G√©n√©rer un userToken invit√© si absent
                let userToken = localStorage.getItem('userToken');
                if (!userToken) {
                    userToken = crypto.randomUUID ? crypto.randomUUID() : ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
                    localStorage.setItem('userToken', userToken);
                }
                const userId = localStorage.getItem('userId') ? parseInt(localStorage.getItem('userId')) : null;

                const response = await fetch('/api/etape1/create_plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ville_id: parseInt(villeId),
                        duree_jours: days,
                        user_token: userToken,
                        user_id: userId
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error('create_plan response not ok', response.status, text);
                    throw new Error('Erreur lors de la cr√©ation du plan: ' + response.status);
                }

                // R√©cup√©rer la r√©ponse texte et tenter un parse JSON robuste
                const text = await response.text();
                let data = null;
                try {
                    data = text ? JSON.parse(text) : null;
                } catch (e) {
                    console.error('Impossible de parser la r√©ponse JSON du create_plan:', e, 'raw:', text);
                    throw new Error('R√©ponse serveur invalide');
                }

                console.log('create_plan response data:', data);

                if (!data || !data.plan_id) {
                    console.error('Aucun plan_id retourn√© par create_plan:', data);
                    alert('La cr√©ation du plan a √©chou√© : r√©ponse inattendue du serveur.');
                    planButton.disabled = false;
                    updatePlanButton();
                    return;
                }

                // Stocker le plan_id et rediriger vers l'√©tape 2
                localStorage.setItem('planId', data.plan_id);
                window.location.href = "{{ url_for('etape2') }}";

            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la cr√©ation du plan. Veuillez r√©essayer.');
                planButton.disabled = false;
                updatePlanButton();
            }
        }
    });
</script>
{% endblock %}