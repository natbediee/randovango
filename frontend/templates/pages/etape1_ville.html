{% extends "base.html" %}

{% set current_step = 1 %}

{% block title %}Étape 1 - Choix de la Ville - RandoVanGo{% endblock %}

{% block hero_subtitle %}Choisissez votre destination pour commencer l'aventure{% endblock %}

{% block planning_content %}
<div class="step-section">
    <div class="step-header">
        <h2>Planifiez votre séjour RandoVanGo</h2>
        <p>Choisissez votre destination et la durée de votre aventure</p>
    </div>

    <!-- Recherche de ville -->
    <div class="search-container">
        <div class="search-input-group">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" id="citySearch" placeholder="Rechercher une ville... (ex: Plougonvelin)" class="search-input" value="Plougonvelin">
            <button class="btn btn-primary" id="searchBtn">
                Rechercher
            </button>
        </div>
    
    </div>

    <!-- Ville sélectionnée -->
    <div class="selected-city" id="selectedCity">
        <div class="card selected">
            <div class="city-header">
                <h3>Plougonvelin</h3>
                <p>Finistère, Bretagne - France</p>
            </div>
            <div class="city-stats">
                <div class="stat-item">
                    <i class="fas fa-hiking"></i>
                    <span>11 randonnées</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-bed"></i>
                    <span>23 spots nuit</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-map-pin"></i>
                    <span>156 points d'intérêt</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Météo 7 jours -->
    <div class="weather-section">
        <h3>🌤️ Météo à Plougonvelin - Prochains jours</h3>
        <p>Consultez les prévisions locales pour choisir la durée idéale de votre séjour</p>
        <div class="weather-grid">
            <div class="weather-day good-weather">
                <div class="day-name">Aujourd'hui</div>
                <div class="weather-icon">☀️</div>
                <div class="temperatures">
                    <span class="temp-max">18°</span>
                    <span class="temp-min">12°</span>
                </div>
                <div class="weather-desc">Parfait pour randonner</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Demain</div>
                <div class="weather-icon">⛅</div>
                <div class="temperatures">
                    <span class="temp-max">16°</span>
                    <span class="temp-min">10°</span>
                </div>
                <div class="weather-desc">Correct</div>
            </div>
            
            <div class="weather-day bad-weather">
                <div class="day-name">Mercredi</div>
                <div class="weather-icon">🌧️</div>
                <div class="temperatures">
                    <span class="temp-max">14°</span>
                    <span class="temp-min">8°</span>
                </div>
                <div class="weather-desc">Éviter les randos</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Jeudi</div>
                <div class="weather-icon">☀️</div>
                <div class="temperatures">
                    <span class="temp-max">19°</span>
                    <span class="temp-min">13°</span>
                </div>
                <div class="weather-desc">Idéal</div>
            </div>
            
            <div class="weather-day">
                <div class="day-name">Vendredi</div>
                <div class="weather-icon">⛅</div>
                <div class="temperatures">
                    <span class="temp-max">17°</span>
                    <span class="temp-min">11°</span>
                </div>
                <div class="weather-desc">Variable</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Samedi</div>
                <div class="weather-icon">☀️</div>
                <div class="temperatures">
                    <span class="temp-max">20°</span>
                    <span class="temp-min">14°</span>
                </div>
                <div class="weather-desc">Parfait</div>
            </div>
            
            <div class="weather-day good-weather">
                <div class="day-name">Dimanche</div>
                <div class="weather-icon">🌤️</div>
                <div class="temperatures">
                    <span class="temp-max">18°</span>
                    <span class="temp-min">12°</span>
                </div>
                <div class="weather-desc">Très bien</div>
            </div>
        </div>
    </div>

    <!-- Durée du séjour -->
    <div class="duration-section">
        <h3>📅 Combien de jours voulez-vous rester ?</h3>
        <p>Consultez la météo ci-dessus pour choisir la durée idéale de votre séjour</p>
        <div class="duration-options">
            <div class="duration-card" data-days="1">
                <div class="duration-number">1</div>
                <div class="duration-label">jour</div>
                <div class="duration-desc">Escapade express</div>
            </div>
            <div class="duration-card active" data-days="2">
                <div class="duration-number">2</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Week-end parfait</div>
            </div>
            <div class="duration-card" data-days="3">
                <div class="duration-number">3</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Long week-end</div>
            </div>
            <div class="duration-card" data-days="7">
                <div class="duration-number">7</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Semaine complète</div>
            </div>
            <div class="duration-card" data-days="custom">
                <div class="duration-number">
                    <input type="number" id="customDays" min="1" max="30" placeholder="?">
                </div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Durée personnalisée</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block navigation %}
<div class="navigation-buttons navigation-right">
    <a href="{{ url_for('planificateur_etape2') }}" class="btn btn-primary btn-large">
        Planifier ces 2 jours
        <i class="fas fa-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
// JavaScript minimal pour la recherche de ville
document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('searchBtn');
    const citySearch = document.getElementById('citySearch');
    
    searchBtn.addEventListener('click', function() {
        const cityName = citySearch.value || 'Plougonvelin';
        // Ici on appellerait l'API FastAPI pour récupérer les données de la ville
        console.log('Recherche de:', cityName);
        
        // Simulation de mise à jour (sera remplacé par l'API)
        document.querySelector('.selected-city h3').textContent = '📍 ' + cityName;
    });
    
    // Géolocalisation
    document.getElementById('geolocateBtn').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                console.log('Position:', position.coords.latitude, position.coords.longitude);
                // Ici on appellerait l'API pour récupérer la ville la plus proche
                alert('Géolocalisation réussie! (Fonctionnalité à implémenter)');
            });
        } else {
            alert('Géolocalisation non supportée par ce navigateur');
        }
    });

    // Sélection de durée
    document.querySelectorAll('.duration-card').forEach(card => {
        card.addEventListener('click', function() {
            // Retirer la classe active de toutes les cartes
            document.querySelectorAll('.duration-card').forEach(c => c.classList.remove('active'));
            // Ajouter la classe active à la carte cliquée
            this.classList.add('active');
            
            const days = this.getAttribute('data-days');
            if (days === 'custom') {
                const input = this.querySelector('#customDays');
                if (input) {
                    input.focus();
                }
            }
            
            // Sauvegarder la sélection
            if (days !== 'custom') {
                localStorage.setItem('trip_duration', days);
                updateNavigationText(days);
            }
        });
    });

    // Gestion de la durée personnalisée
    const customInput = document.getElementById('customDays');
    if (customInput) {
        customInput.addEventListener('input', function() {
            const days = parseInt(this.value);
            if (days >= 1 && days <= 30) {
                localStorage.setItem('trip_duration', days);
                updateNavigationText(days);
            }
        });
    }

    function updateNavigationText(days) {
        const navigationBtn = document.querySelector('.navigation-buttons .btn-primary');
        if (navigationBtn) {
            if (days == 1) {
                navigationBtn.innerHTML = 'Planifier cette journée <i class="fas fa-arrow-right"></i>';
            } else {
                navigationBtn.innerHTML = `Planifier ces ${days} jours <i class="fas fa-arrow-right"></i>`;
            }
        }
    }

    // Interaction météo pour aider la décision
    document.querySelectorAll('.weather-day').forEach((day, index) => {
        day.addEventListener('click', function() {
            const dayName = this.querySelector('.day-name').textContent;
            const isGoodWeather = this.classList.contains('good-weather');
            const isBadWeather = this.classList.contains('bad-weather');
            
            let suggestion = '';
            if (isGoodWeather) {
                suggestion = `${dayName} : Parfait pour une randonnée ! 🥾`;
            } else if (isBadWeather) {
                suggestion = `${dayName} : Jour de pluie, idéal pour visiter des sites couverts ou se reposer 🏛️`;
            } else {
                suggestion = `${dayName} : Temps variable, activités flexibles recommandées 🤔`;
            }
            
            // Suggérer une durée basée sur la météo
            if (index <= 1 && !isBadWeather) {
                suggestion += '\n💡 Suggestion: Profitez de ces beaux jours pour un court séjour (1-2 jours)';
            } else if (index >= 5 && isGoodWeather) {
                suggestion += '\n💡 Suggestion: Beau temps en fin de semaine, parfait pour un long séjour !';
            }
            
            // Afficher la suggestion
            const existingTooltip = document.querySelector('.weather-tooltip');
            if (existingTooltip) existingTooltip.remove();
            
            const tooltip = document.createElement('div');
            tooltip.className = 'weather-tooltip';
            tooltip.textContent = suggestion;
            tooltip.style.cssText = `
                position: fixed;
                background: var(--blue);
                color: white;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: var(--shadow-hover);
                z-index: 1000;
                max-width: 300px;
                font-size: 0.9rem;
                white-space: pre-line;
            `;
            
            document.body.appendChild(tooltip);
            
            const rect = this.getBoundingClientRect();
            tooltip.style.left = Math.min(rect.left, window.innerWidth - tooltip.offsetWidth - 20) + 'px';
            tooltip.style.top = (rect.top - tooltip.offsetHeight - 10) + 'px';
            
            setTimeout(() => tooltip.remove(), 3000);
        });
    });

    // Initialiser avec la sélection par défaut (2 jours)
    localStorage.setItem('trip_duration', '2');
    updateNavigationText(2);
});
</script>
{% endblock %}