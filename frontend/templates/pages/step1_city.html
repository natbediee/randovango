{% extends "base.html" %}

{% block title %}√âtape 1 - Choix de la Ville - RandoVanGo{% endblock %}

{% block page_content %}
<div class="main-container">
    <div class="page-header">
        <div class="hero-section">
            <img src="{{ url_for('static', filename='images/van-life-liberte.jpg') }}" alt="Planificateur Van Life" class="hero-background">
            <div class="hero-overlay"></div>
            <div class="hero-logo-container">
                <div class="hero-logo-white">
                    <img src="{{ url_for('static', filename='images/logo_randovango.png') }}" alt="RandoVanGo" class="hero-logo-img">
                </div>
            </div>
            <div class="hero-content">
                <h1 class="hero-title">Planificateur RandoVanGo</h1>
                <p class="hero-subtitle">Choisissez votre destination pour commencer l'aventure</p>
            </div>
            
            <!-- Widget d'authentification et upload GPX -->
            <div id="floatingLogin" style="position: absolute; bottom: 20px; top: 50%; transform: translateY(-50%); right: 20px; z-index: 1000; background: rgba(255,255,255,0.98); padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px;min-height: 230px;">
                <!-- Formulaire de connexion (visible si non connect√©) -->
                <div id="loginForm" class="stepper-login" style="position: static !important; transform: none !important;">
                    <p style="text-align: center; font-size: 0.9rem; color: #555; margin-bottom: 1rem; padding: 0 0.5rem;">
                        Pour ins√©rer <br>de nouvelles randonn√©es !
                    </p>
                    <form id="stepperLoginForm" class="stepper-login-form" style="display: flex; flex-direction: column; gap: 1rem;">
                        <input type="text" id="stepperLogin" class="form-input" placeholder="Identifiant" required style="width: 100%;">
                        <input type="password" id="stepperLoginPassword" class="form-input" placeholder="Mot de passe" required style="width: 100%;">
                        <button type="submit" class="btn btn-primary btn-sm" style="width: 100%;"><i class="fas fa-sign-in-alt"></i> Connexion Contributeur</button>
                    </form>
                    <div id="stepperLoginError" class="alert alert-danger" style="display:none; margin-top: 0.5rem; font-size: 0.85em;"></div>
                </div>
                
                <!-- Menu utilisateur et upload GPX (visible si connect√©) -->
                <div id="userMenu" class="user-menu" style="display: none;">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: stretch;">
                        <div class="user-info" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f0f0f0; border-radius: 4px;">
                            <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
                            <span id="userName" style="font-weight: 500;">Contributeur</span>
                        </div>
                        <!-- Formulaire d'upload GPX -->
                        <form id="gpxUploadForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 0.2rem;">
                            <label for="gpxFileInput" class="btn btn-outline" style="margin: 0; cursor: pointer; text-align: center; padding: 0.5rem; font-size: 0.9rem;">
                                <i class="fas fa-file-upload"></i> Choisir un fichier GPX
                            </label>
                            <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;" required>
                            <div id="fileName" style="font-size: 0.9em; color: #666; text-align: center;  font-weight: 500;"></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;" disabled id="uploadBtn">
                                <i class="fas fa-cloud-upload-alt"></i> Envoyer la rando                            </button>
                        </form>
                        <div id="gpxUploadError" class="alert alert-danger" style="display:none; padding: 0.75rem; font-size: 0.9em;"></div>
                        <div id="gpxUploadSuccess" class="alert alert-success" style="display:none; padding: 0.75rem; font-size: 0.9em;"></div>

                        <button id="logoutBtn" class="btn btn-outline" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;"><i class="fas fa-sign-out-alt"></i> Se d√©connecter</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="planning-stepper">
        <div class="stepper-container">
            <div class="step active">
                <div class="step-circle">1</div>
                <div class="step-label">Ville</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">2</div>
                <div class="step-label">Randonn√©e</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">3</div>
                <div class="step-label">Nuit</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">4</div>
                <div class="step-label">Services</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">üìã</div>
                <div class="step-label">R√©sultat</div>
            </div>
        </div>
    </div>
    
    <div class="planning-content">
<div class="step-section">
    <div class="step-header">
        <h2>Planifiez votre s√©jour RandoVanGo</h2>
        <p>Choisissez votre destination et la dur√©e de votre aventure</p>
    </div>

    <!-- Recherche de ville -->

    <div class="search-container">
        <div class="search-input-group">
            <i class="fas fa-map-marker-alt"></i>
            <select id="citySelect" class="search-input">
                {% for city in cities %}
                    <option value="{{ city.id }}" 
                            data-lat="{{ city.latitude }}" 
                            data-lon="{{ city.longitude }}" 
                            data-name="{{ city.name }}" 
                            data-dept="{{ city.department or '' }}" 
                            data-country="{{ city.country or '' }}" 
                            data-hikes="{{ city.stats.hikes }}" 
                            data-spots="{{ city.stats.spots }}" 
                            data-poi="{{ city.stats.poi }}"
                            data-meteo='{{ city.meteo | tojson }}'>
                        {{ city.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Ville s√©lectionn√©e -->
    <div class="selected-city" id="selectedCity">
        <div class="card selected">
            <div class="city-header">
                <h3 id="cityName">{{ cities[0].name if cities else '' }}</h3>
                <p id="cityDept">
                    {{ cities[0].department if cities else '' }}
                    {% if cities and cities[0].region %} - {{ cities[0].region }}{% endif %}
                    {% if cities and cities[0].country %} - {{ cities[0].country }}{% endif %}
                </p>
            </div>
            <div class="city-stats">
                <div class="stat-item">
                    <i class="fas fa-hiking"></i>
                    <span id="cityHikes">{{ cities[0].stats.hikes if cities else 0 }} {% if cities and cities[0].stats.hikes < 2 %} randonn√©e {% else %} randonn√©es {% endif %}</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-bed"></i>
                    <span id="citySpots">{{ cities[0].stats.spots if cities else 0 }} spots nuit</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-map-pin"></i>
                    <span id="cityServices">{{ cities[0].stats.poi if cities else 0 }} points d'int√©r√™t</span>
                </div>
            </div>
        </div>
    </div>

     <!-- Carte interactive -->
    <div class="map-page-container" style="margin: 2rem 0;">
        <h3 class="map-title">Visualisation sur la carte</h3>
        <div id="map" style="height: 40vh; width: 100%; border-radius: 12px; box-shadow: 0 2px 8px #0002;"></div>
    </div>
    <!-- M√©t√©o 7 jours -->
    <div class="weather-section">
        <h3 id="weatherTitle">üå§Ô∏è M√©t√©o √† {{ cities[0].name if cities else '' }} - Prochains jours</h3>
        <p>Consultez les pr√©visions locales pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="weather-grid" id="weatherGrid">
            {% if cities and cities[0].meteo %}
                {% for forecast in cities[0].meteo %}
                <div class="weather-day {% if forecast.weather_code < 45 %}good-weather{% elif forecast.weather_code <= 65 %}acceptable-weather{% else %}bad-weather{% endif %}">
                    <div class="day-name">{% if loop.index == 1 %}Aujourd'hui{% else %}Jour {{ loop.index }}{% endif %}</div>
                    <div class="weather-icon">
                        <img src="/static/images/wheather/{{ forecast.picto }}.png" alt="{{ forecast.picto }}" style="width: 100%; max-width: 80px; height: auto;">
                    </div>
                    <div class="temperatures">
                        <span class="temp-max">{{ forecast.temp_max|round|int }}¬∞</span>
                        <span class="temp-min">{{ forecast.temp_min|round|int }}¬∞</span>
                    </div>
                    <div class="weather-details">
                        
                        <div class="weather-info">
                            <i class="fas fa-tint"></i> {{ forecast.precipitation_sum|round(1) }} mm
                        </div>
                      

                        <div class="weather-info">
                            <i class="fas fa-wind"></i> {{ forecast.wind_speed_max|round|int }} km/h
                        </div>
                    </div>
                    <div class="weather-advice">
                        {% if forecast.picto == 'sun' %}
                            <i class="fas fa-check-circle"></i> Parfait pour randonner
                        {% elif forecast.picto == 'storm' %}
                            <i class="fas fa-exclamation-triangle"></i> √âviter les randos
                        {% elif forecast.picto == 'rain' or forecast.picto == 'snow' %}
                            <i class="fas fa-info-circle"></i> √âquipements conseill√©s
                        {% elif forecast.picto == 'fog' %}
                            <i class="fas fa-eye-slash"></i> Avec prudence
                        {% elif forecast.picto == 'cloud' %}
                            <i class="fas fa-cloud"></i> Conditions correctes
                        {% elif forecast.picto == 'indisponible' %}
                            <i class="fas fa-question-circle"></i> M√©t√©o indisponible
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>Aucune donn√©e m√©t√©o disponible</p>
            {% endif %}
        </div>
    </div>

    <!-- Dur√©e du s√©jour -->
    <div class="duration-section">
        <h3>üìÖ Combien de jours voulez-vous rester ?</h3>
        <p>Consultez la m√©t√©o ci-dessus pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="duration-options">
            <div class="duration-card" data-days="1">
                <div class="duration-number">1</div>
                <div class="duration-label">jour</div>
                <div class="duration-desc">Escapade express</div>
            </div>
            <div class="duration-card active" data-days="2">
                <div class="duration-number">2</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Week-end parfait</div>
            </div>
            <div class="duration-card" data-days="3">
                <div class="duration-number">3</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Long week-end</div>
            </div>
            <div class="duration-card" data-days="7">
                <div class="duration-number">7</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Semaine compl√®te</div>
            </div>
            <div class="duration-card" data-days="custom">
                <div class="duration-number">
                    <input type="number" id="customDays" min="1" max="30" placeholder="?">
                </div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Dur√©e personnalis√©e</div>
            </div>
        </div>
    </div>
</div>

<div class="planning-navigation">
    <div class="navigation-buttons navigation-right">
        <button id="planButton" class="btn btn-primary btn-large">
            Planifier ces 2 jours
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // Gestion de l'authentification et affichage conditionnel
    document.addEventListener('DOMContentLoaded', function() {
        const loginForm = document.getElementById('loginForm');
        const userMenu = document.getElementById('userMenu');
        const stepperLoginForm = document.getElementById('stepperLoginForm');
        const stepperLoginError = document.getElementById('stepperLoginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const gpxUploadForm = document.getElementById('gpxUploadForm');
        const gpxFileInput = document.getElementById('gpxFileInput');
        const fileName = document.getElementById('fileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const gpxUploadError = document.getElementById('gpxUploadError');
        const gpxUploadSuccess = document.getElementById('gpxUploadSuccess');

        // V√©rifier si le token JWT est expir√© (d√©codage base64, lecture exp)
        function isJwtExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                if (!payload.exp) return true;
                // exp est en secondes depuis epoch
                const now = Math.floor(Date.now() / 1000);
                return payload.exp < now;
            } catch (e) {
                return true;
            }
        }

        let token = sessionStorage.getItem('jwtToken');
        const username = sessionStorage.getItem('username');

        // Si token expir√©, on le supprime et on force la d√©connexion
        if (token && isJwtExpired(token)) {
            sessionStorage.removeItem('jwtToken');
            sessionStorage.removeItem('username');
            token = null;
        }

        if (token && username) {
            // Utilisateur connect√© : afficher le menu utilisateur
            loginForm.style.display = 'none';
            userMenu.style.display = 'block';
            document.getElementById('userName').textContent = username;
        } else {
            // Utilisateur non connect√© : afficher le formulaire de connexion
            loginForm.style.display = 'block';
            userMenu.style.display = 'none';
        }
        
        // Gestion de la connexion
        if (stepperLoginForm) {
            stepperLoginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                stepperLoginError.style.display = 'none';
                const login = document.getElementById('stepperLogin').value;
                const password = document.getElementById('stepperLoginPassword').value;
                
                try {
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: login, password: password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Stocker le token et le nom d'utilisateur
                        sessionStorage.setItem('jwtToken', data.token);
                        sessionStorage.setItem('username', data.username);
                        
                        // Recharger la page pour afficher le menu utilisateur
                        location.reload();
                    } else {
                        stepperLoginError.textContent = data.message || 'Erreur de connexion';
                        stepperLoginError.style.display = 'block';
                    }
                } catch (err) {
                    console.error('Erreur connexion:', err);
                    stepperLoginError.textContent = 'Erreur r√©seau ou serveur';
                    stepperLoginError.style.display = 'block';
                }
            });
        }
        
        // Gestion de la d√©connexion
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                sessionStorage.removeItem('jwtToken');
                sessionStorage.removeItem('username');
                location.reload();
            });
        }
        
        // Gestion de la s√©lection de fichier GPX
        if (gpxFileInput) {
            gpxFileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    fileName.textContent = this.files[0].name;
                    uploadBtn.disabled = false;
                } else {
                    fileName.textContent = '';
                    uploadBtn.disabled = true;
                }
            });
        }
        
        // Gestion de l'upload GPX
        if (gpxUploadForm) {
            gpxUploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                gpxUploadError.style.display = 'none';
                gpxUploadSuccess.style.display = 'none';
                
                const file = gpxFileInput.files[0];
                if (!file) {
                    gpxUploadError.textContent = 'Veuillez s√©lectionner un fichier';
                    gpxUploadError.style.display = 'block';
                    return;
                }
                
                // V√©rifier que le token JWT est pr√©sent
                if (!token) {
                    gpxUploadError.textContent = 'Vous devez √™tre connect√© pour uploader un fichier. Veuillez vous reconnecter.';
                    gpxUploadError.style.display = 'block';
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Upload en cours...';
                    // Appel via le proxy Flask (plus propre que http://localhost:8000)
                    const response = await fetch('/upload_gpx', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        body: formData
                    });
                    
                    // Parse response safely: si JSON => parse, sinon lire texte brut
                    let data = null;
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        try {
                            data = await response.json();
                        } catch (e) {
                            console.error('Erreur parsing JSON:', e);
                            const text = await response.text();
                            gpxUploadError.textContent = `R√©ponse serveur non valide (status ${response.status}): ${text}`;
                            gpxUploadError.style.display = 'block';
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                            return;
                        }
                    } else {
                        // contenu non-JSON (HTML erreur ou autre)
                        const text = await response.text();
                        if (response.ok) {
                            // succ√®s mais non-JSON: afficher texte brut
                            gpxUploadSuccess.textContent = text;
                            gpxUploadSuccess.style.display = 'block';
                            gpxUploadForm.reset();
                            fileName.textContent = '';
                            uploadBtn.disabled = true;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                            setTimeout(() => { location.reload(); }, 2000);
                            return;
                        } else {
                            gpxUploadError.textContent = `Erreur serveur (status ${response.status}): ${text}`;
                            gpxUploadError.style.display = 'block';
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                            return;
                        }
                    }

                    if (response.ok && data && data.success) {
                        const cityMsg = data.city ? ` - Ville d√©tect√©e : ${data.city}. Vous pouvez maintenant la s√©lectionner dans la liste pour voir les nouveaux r√©sultats.` : '';
                        gpxUploadSuccess.textContent = data.message + cityMsg;
                        gpxUploadSuccess.style.display = 'block';
                        
                        // Afficher le bouton "Rafra√Æchir les donn√©es"
                        const refreshDataBtn = document.getElementById('refreshDataBtn');
                        if (refreshDataBtn) {
                            refreshDataBtn.style.display = 'block';
                        }
                        
                        // R√©initialiser le formulaire
                        gpxUploadForm.reset();
                        fileName.textContent = '';
                        uploadBtn.disabled = true;
                        uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                        
                        // Si une ville est retourn√©e, la s√©lectionner dans le dropdown (sans rechargement)
                        if (data.city) {
                            // Trouver l'option correspondant √† la ville
                            const citySelect = document.getElementById('citySelect');
                            if (citySelect) {
                                for (let i = 0; i < citySelect.options.length; i++) {
                                    if (citySelect.options[i].getAttribute('data-name') === data.city) {
                                        citySelect.selectedIndex = i;
                                        // D√©clencher l'√©v√©nement change pour mettre √† jour la carte et les infos
                                        citySelect.dispatchEvent(new Event('change'));
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        gpxUploadError.textContent = data.message || 'Erreur lors de l\'upload';
                        gpxUploadError.style.display = 'block';
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                    }
                } catch (err) {
                    console.error('Erreur upload:', err);
                    gpxUploadError.textContent = 'Erreur r√©seau ou serveur';
                    gpxUploadError.style.display = 'block';
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                }
            });
        }
        
        // Gestion du bouton "Rafra√Æchir les donn√©es"
        const refreshDataBtn = document.getElementById('refreshDataBtn');
        if (refreshDataBtn) {
            refreshDataBtn.addEventListener('click', async function() {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rafra√Æchissement...';
                
                try {
                    // Recharger les donn√©es de la ville depuis l'API
                    const userRole = sessionStorage.getItem('jwtToken') ? 'admin' : 'user';
                    const response = await fetch(`/api/step1/cities?user_role=${userRole}`);
                    
                    if (!response.ok) {
                        throw new Error('Erreur lors du rechargement des donn√©es');
                    }
                    
                    const cities = await response.json();
                    
                    // Mettre √† jour le dropdown avec les nouvelles donn√©es
                    const citySelect = document.getElementById('citySelect');
                    const currentCityName = citySelect.options[citySelect.selectedIndex].getAttribute('data-name');
                    
                    // Vider et reconstruire les options
                    citySelect.innerHTML = '';
                    cities.forEach((city, index) => {
                        const option = document.createElement('option');
                        option.value = city.id;
                        option.setAttribute('data-lat', city.latitude);
                        option.setAttribute('data-lon', city.longitude);
                        option.setAttribute('data-name', city.name);
                        option.setAttribute('data-dept', city.department || '');
                        option.setAttribute('data-country', city.country || '');
                        option.setAttribute('data-hikes', city.stats.hikes);
                        option.setAttribute('data-spots', city.stats.spots);
                        option.setAttribute('data-poi', city.stats.poi);
                        option.setAttribute('data-meteo', JSON.stringify(city.meteo));
                        option.textContent = city.name;
                        citySelect.appendChild(option);
                        
                        // Res√©lectionner la ville courante
                        if (city.name === currentCityName) {
                            citySelect.selectedIndex = index;
                        }
                    });
                    
                    // D√©clencher l'√©v√©nement change pour mettre √† jour l'affichage
                    citySelect.dispatchEvent(new Event('change'));
                    
                    this.innerHTML = '<i class="fas fa-check"></i> Donn√©es rafra√Æchies !';
                    setTimeout(() => {
                        this.style.display = 'none';
                        this.innerHTML = '<i class="fas fa-sync-alt"></i> Rafra√Æchir les donn√©es';
                        this.disabled = false;
                    }, 2000);
                    
                } catch (error) {
                    console.error('Erreur rafra√Æchissement:', error);
                    this.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erreur';
                    setTimeout(() => {
                        this.innerHTML = '<i class="fas fa-sync-alt"></i> Rafra√Æchir les donn√©es';
                        this.disabled = false;
                    }, 2000);
                }
            });
        }
        
        // Gestion dynamique de la s√©lection de ville avec carte et m√©t√©o
        const select = document.getElementById('citySelect');
        if (!select) return;
        
        // Variables pour la carte Leaflet
        let cityMap = null;
        let cityMarker = null;
        
        // Initialisation de la carte sur la premi√®re ville
        const mapElement = document.getElementById('map');
        if (window.L && mapElement && !mapElement._leaflet_id) {
            const opt = select.options[select.selectedIndex];
            const lat = parseFloat(opt.getAttribute('data-lat'));
            const lon = parseFloat(opt.getAttribute('data-lon'));
            
            cityMap = L.map('map').setView([lat, lon], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(cityMap);
            cityMarker = L.marker([lat, lon]).addTo(cityMap);
        }
        
        // √âcouter le changement de ville
        select.addEventListener('change', function() {
            const opt = select.options[select.selectedIndex];
            const cityName = opt.getAttribute('data-name');
            // Mise √† jour des informations de la ville
            document.getElementById('cityName').textContent = cityName;
            const dept = opt.getAttribute('data-dept') || '';
            const country = opt.getAttribute('data-country') || '';
            document.getElementById('cityDept').textContent = dept + (country ? ' - ' + country : '');
            document.getElementById('cityHikes').textContent = opt.getAttribute('data-hikes') + ' randonn√©es';
            document.getElementById('citySpots').textContent = opt.getAttribute('data-spots') + ' spots nuit';
            document.getElementById('cityServices').textContent = opt.getAttribute('data-poi') + " points d'int√©r√™t";
            document.getElementById('weatherTitle').textContent = 'üå§Ô∏è M√©t√©o √† ' + cityName + ' - Prochains jours';
            // Mise √† jour de la m√©t√©o
            updateWeatherDisplay(opt);
            // Mise √† jour de la carte
            updateMap(opt);
        });
        
        // Fonction pour mettre √† jour l'affichage m√©t√©o
        function updateWeatherDisplay(option) {
            let meteoData = [];
            try {
                meteoData = JSON.parse(option.getAttribute('data-meteo'));
            } catch (e) {
                console.error('Erreur parsing m√©t√©o:', e.message);
            }
            
            const weatherGrid = document.getElementById('weatherGrid');
            weatherGrid.innerHTML = '';
            
            if (meteoData && meteoData.length > 0) {
                const daysOfWeek = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const months = ['janv', 'f√©vr', 'mars', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sept', 'oct', 'nov', 'd√©c'];
                
                meteoData.forEach((forecast, index) => {
                    const date = new Date(forecast.date);
                    const dayName = index === 0 ? "Aujourd'hui" : 
                        `${daysOfWeek[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
                    
                    // Classe CSS selon le weather_code
                    let weatherClass = 'good-weather';
                    if (forecast.weather_code >= 45 && forecast.weather_code <= 65) {
                        weatherClass = 'acceptable-weather';
                    } else if (forecast.weather_code > 65) {
                        weatherClass = 'bad-weather';
                    }
                    
                    // Message de conseil selon le type de temps
                    const adviceMap = {
                        'sun': { icon: 'fa-check-circle', text: 'Parfait pour randonner' },
                        'storm': { icon: 'fa-exclamation-triangle', text: '√âviter les randos' },
                        'rain': { icon: 'fa-info-circle', text: '√âquipements conseill√©s' },
                        'snow': { icon: 'fa-info-circle', text: '√âquipements conseill√©s' },
                        'fog': { icon: 'fa-eye-slash', text: 'Avec prudence' },
                        'cloud': { icon: 'fa-cloud', text: 'Conditions correctes' },
                        'indisponible': { icon: 'fa-question-circle', text: 'M√©t√©o indisponible' }
                    };
                    const advice = adviceMap[forecast.picto] || adviceMap['indisponible'];
                    
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'weather-day ' + weatherClass;
                    dayDiv.innerHTML = `
                        <div class="day-name">${dayName}</div>
                        <div class="weather-icon">
                            <img src="/static/images/wheather/${forecast.picto}.png" alt="${forecast.picto}" 
                                 style="width: 100%; max-width: 80px; height: auto;">
                        </div>
                        <div class="temperatures">
                            <span class="temp-max">${Math.round(forecast.temp_max)}¬∞</span>
                            <span class="temp-min">${Math.round(forecast.temp_min)}¬∞</span>
                        </div>
                        <div class="weather-details">
                            ${forecast.precipitation_sum > 0 ? 
                                `<div class="weather-info"><i class="fas fa-tint"></i> ${forecast.precipitation_sum.toFixed(1)} mm</div>` : ''}
                            ${forecast.wind_speed_max > 0 ? 
                                `<div class="weather-info"><i class="fas fa-wind"></i> ${Math.round(forecast.wind_speed_max)} km/h</div>` : ''}
                        </div>
                        <div class="weather-advice">
                            <i class="fas ${advice.icon}"></i> ${advice.text}
                        </div>
                    `;
                    weatherGrid.appendChild(dayDiv);
                });
            } else {
                weatherGrid.innerHTML = '<p>Aucune donn√©e m√©t√©o disponible</p>';
            }
        }
        
        // Fonction pour mettre √† jour la carte
        function updateMap(option) {
            if (!cityMap || !window.L) return;
            
            const lat = parseFloat(option.getAttribute('data-lat'));
            const lon = parseFloat(option.getAttribute('data-lon'));
            
            if (!isNaN(lat) && !isNaN(lon)) {
                cityMap.setView([lat, lon], 12);
                if (cityMarker) {
                    cityMap.removeLayer(cityMarker);
                }
                cityMarker = L.marker([lat, lon]).addTo(cityMap);
            }
        }
        
        // Gestion de la s√©lection de la dur√©e
        let selectedDays = 2; // Par d√©faut 2 jours
        const durationCards = document.querySelectorAll('.duration-card');
        const planButton = document.getElementById('planButton');
        
        durationCards.forEach(card => {
            card.addEventListener('click', function() {
                // Retirer la classe active de toutes les cards
                durationCards.forEach(c => c.classList.remove('active'));
                
                // Ajouter la classe active √† la card cliqu√©e
                this.classList.add('active');
                
                // R√©cup√©rer le nombre de jours
                const days = this.getAttribute('data-days');
                
                if (days === 'custom') {
                    const customInput = document.getElementById('customDays');
                    customInput.focus();
                    customInput.addEventListener('input', function() {
                        selectedDays = parseInt(this.value) || 2;
                        updatePlanButton();
                    });
                } else {
                    selectedDays = parseInt(days);
                    updatePlanButton();
                }
            });
        });
        
        // Mettre √† jour le texte du bouton
        function updatePlanButton() {
            if (planButton) {
                const dayText = selectedDays === 1 ? 'jour' : 'jours';
                planButton.innerHTML = `Planifier ces ${selectedDays} ${dayText} <i class="fas fa-arrow-right"></i>`;
            }
        }
        
        // Appel de l'API create_plan au clic sur le bouton
        if (planButton) {
            planButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const selectedOption = select.options[select.selectedIndex];
                const cityId = selectedOption.value;
                
                // Stocker en localStorage
                localStorage.setItem('selectedCityId', cityId);
                localStorage.setItem('selectedDays', selectedDays);
                
                // Appeler l'API create_plan
                createPlan(cityId, selectedDays);
            });
        }
        
        // Fonction pour appeler l'API create_plan
        async function createPlan(cityId, days) {
            try {
                planButton.disabled = true;
                planButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation du plan...';

                // G√©n√©rer un userToken invit√© si absent
                let userToken = localStorage.getItem('userToken');
                if (!userToken) {
                    userToken = crypto.randomUUID ? crypto.randomUUID() : ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
                    localStorage.setItem('userToken', userToken);
                }
                const userId = localStorage.getItem('userId') ? parseInt(localStorage.getItem('userId')) : null;

                const response = await fetch('/api/step1/create_plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city_id: parseInt(cityId),
                        duration_days: days,
                        user_token: userToken,
                        user_id: userId
                    })
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error('create_plan response not ok', response.status, text);
                    throw new Error('Erreur lors de la cr√©ation du plan: ' + response.status);
                }

                // R√©cup√©rer la r√©ponse texte et tenter un parse JSON robuste
                const text = await response.text();
                let data = null;
                try {
                    data = text ? JSON.parse(text) : null;
                } catch (e) {
                    console.error('Impossible de parser la r√©ponse JSON du create_plan:', e, 'raw:', text);
                    throw new Error('R√©ponse serveur invalide');
                }

                console.log('create_plan response data:', data);

                if (!data || !data.plan_id) {
                    console.error('Aucun plan_id retourn√© par create_plan:', data);
                    alert('La cr√©ation du plan a √©chou√© : r√©ponse inattendue du serveur.');
                    planButton.disabled = false;
                    updatePlanButton();
                    return;
                }

                // Stocker le plan_id et rediriger vers l'√©tape 2
                localStorage.setItem('planId', data.plan_id);
                window.location.href = "{{ url_for('step2') }}";

            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la cr√©ation du plan. Veuillez r√©essayer.');
                planButton.disabled = false;
                updatePlanButton();
            }
        }
    });
</script>
{% endblock %}