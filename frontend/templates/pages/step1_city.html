{% extends "base.html" %}

{% block title %}√âtape 1 - Choix de la Ville - RandoVanGo{% endblock %}

{% block page_content %}
<div class="main-container">
    <div class="page-header">
        <div class="hero-section">
            <img src="{{ url_for('static', filename='images/van-life-liberte.jpg') }}" alt="Planificateur Van Life" class="hero-background">
            <div class="hero-overlay"></div>
            <div class="hero-logo-container">
                <div class="hero-logo-white">
                    <img src="{{ url_for('static', filename='images/logo_randovango.png') }}" alt="RandoVanGo" class="hero-logo-img">
                </div>
            </div>
            <div class="hero-content">
                <h1 class="hero-title">Planificateur RandoVanGo</h1>
                <p class="hero-subtitle">Choisissez votre destination pour commencer l'aventure</p>
            </div>
            
            <!-- Widget d'authentification et upload GPX -->
            <div id="floatingLogin" style="position: absolute; bottom: 20px; top: 50%; transform: translateY(-50%); right: 20px; z-index: 1000; background: rgba(255,255,255,0.98); padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 400px;min-height: 230px;">
                <!-- Formulaire de connexion (visible si non connect√©) -->
                <div id="loginForm" class="stepper-login" style="position: static !important; transform: none !important;">
                    <p style="text-align: center; font-size: 0.9rem; color: #555; margin-bottom: 1rem; padding: 0 0.5rem;">
                        Pour ins√©rer <br>de nouvelles randonn√©es !
                    </p>
                    <form id="stepperLoginForm" class="stepper-login-form" style="display: flex; flex-direction: column; gap: 1rem;">
                        <input type="text" id="stepperLogin" class="form-input" placeholder="Identifiant" required style="width: 100%;">
                        <input type="password" id="stepperLoginPassword" class="form-input" placeholder="Mot de passe" required style="width: 100%;">
                        <button type="submit" class="btn btn-primary btn-sm" style="width: 100%;"><i class="fas fa-sign-in-alt"></i> Connexion Contributeur</button>
                    </form>
                    <div id="stepperLoginError" class="alert alert-danger" style="display:none; margin-top: 0.5rem; font-size: 0.85em;"></div>
                </div>
                
                <!-- Menu utilisateur et upload GPX (visible si connect√©) -->
                <div id="userMenu" class="user-menu" style="display: none;">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: stretch;">
                        <div class="user-info" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f0f0f0; border-radius: 4px;">
                            <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
                            <span id="userName" style="font-weight: 500;">Contributeur</span>
                        </div>
                        <!-- Formulaire d'upload GPX -->
                        <form id="gpxUploadForm" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 0.2rem;">
                            <label for="gpxFileInput" class="btn btn-outline" style="margin: 0; cursor: pointer; text-align: center; padding: 0.5rem; font-size: 0.9rem;">
                                <i class="fas fa-file-upload"></i> Choisir un fichier GPX
                            </label>
                            <input type="file" id="gpxFileInput" accept=".gpx" style="display: none;" required>
                            <div id="fileName" style="font-size: 0.9em; color: #666; text-align: center;  font-weight: 500;"></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;" disabled id="uploadBtn">
                                <i class="fas fa-cloud-upload-alt"></i> Envoyer la rando                            </button>
                        </form>
                        <div id="gpxUploadError" class="alert alert-danger" style="display:none; padding: 0.75rem; font-size: 0.9em;"></div>
                        <div id="gpxUploadSuccess" class="alert alert-success" style="display:none; padding: 0.75rem; font-size: 0.9em;"></div>

                        <button id="logoutBtn" class="btn btn-outline" style="width: 100%; padding: 0.5rem; font-size: 0.9rem;"><i class="fas fa-sign-out-alt"></i> Se d√©connecter</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="planning-stepper">
        <div class="stepper-container">
            <div class="step active">
                <div class="step-circle">1</div>
                <div class="step-label">Ville</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">2</div>
                <div class="step-label">Randonn√©e</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">3</div>
                <div class="step-label">Nuit</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">4</div>
                <div class="step-label">Services</div>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">üìã</div>
                <div class="step-label">R√©sultat</div>
            </div>
        </div>
    </div>
    
    <div class="planning-content">
<div class="step-section">
    <div class="step-header">
        <h2>Planifiez votre s√©jour RandoVanGo</h2>
        <p>Choisissez votre destination et la dur√©e de votre aventure</p>
    </div>

    <!-- Recherche de ville -->

    <div class="search-container">
        <div class="search-input-group">
            <i class="fas fa-map-marker-alt"></i>
            <select id="citySelect" class="search-input">
                {% for city in cities %}
                    <option value="{{ city.id }}" 
                            data-lat="{{ city.latitude }}" 
                            data-lon="{{ city.longitude }}" 
                            data-name="{{ city.name }}" 
                            data-dept="{{ city.department or '' }}" 
                            data-country="{{ city.country or '' }}" 
                            data-hikes="{{ city.stats.hikes }}" 
                            data-spots="{{ city.stats.spots }}" 
                            data-poi="{{ city.stats.poi }}"
                            data-meteo='{{ city.meteo | tojson }}'>
                        {{ city.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Ville s√©lectionn√©e -->
    <div class="selected-city" id="selectedCity">
        <div class="card selected">
            <div class="city-header">
                <h3 id="cityName">{{ cities[0].name if cities else '' }}</h3>
                <p id="cityDept">
                    {{ cities[0].department if cities else '' }}
                    {% if cities and cities[0].region %} - {{ cities[0].region }}{% endif %}
                    {% if cities and cities[0].country %} - {{ cities[0].country }}{% endif %}
                </p>
            </div>
            <div class="city-stats">
                <div class="stat-item">
                    <i class="fas fa-hiking"></i>
                    <span id="cityHikes">{{ cities[0].stats.hikes if cities else 0 }} {% if cities and cities[0].stats.hikes < 2 %} randonn√©e {% else %} randonn√©es {% endif %}</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-bed"></i>
                    <span id="citySpots">{{ cities[0].stats.spots if cities else 0 }} spots nuit</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-map-pin"></i>
                    <span id="cityServices">{{ cities[0].stats.poi if cities else 0 }} points d'int√©r√™t</span>
                </div>
            </div>
        </div>
    </div>

     <!-- Carte interactive -->
    <div class="map-page-container" style="margin: 2rem 0;">
        <h3 class="map-title">Visualisation sur la carte</h3>
        <div id="map" style="height: 40vh; width: 100%; border-radius: 12px; box-shadow: 0 2px 8px #0002;"></div>
    </div>
    <!-- M√©t√©o 7 jours -->
    <div class="weather-section">
        <h3 id="weatherTitle">üå§Ô∏è M√©t√©o √† {{ cities[0].name if cities else '' }} - Prochains jours</h3>
        <p>Consultez les pr√©visions locales pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="weather-grid" id="weatherGrid">
            {% if cities and cities[0].meteo %}
                {% for forecast in cities[0].meteo %}
                <div class="weather-day {% if forecast.weather_code < 45 %}good-weather{% elif forecast.weather_code <= 65 %}acceptable-weather{% else %}bad-weather{% endif %}">
                    <div class="day-name">{% if loop.index == 1 %}Aujourd'hui{% else %}Jour {{ loop.index }}{% endif %}</div>
                    <div class="weather-icon">
                        <img src="/static/images/wheather/{{ forecast.picto }}.png" alt="{{ forecast.picto }}" style="width: 100%; max-width: 80px; height: auto;">
                    </div>
                    <div class="temperatures">
                        <span class="temp-max">{{ forecast.temp_max|round|int }}¬∞</span>
                        <span class="temp-min">{{ forecast.temp_min|round|int }}¬∞</span>
                    </div>
                    <div class="weather-details">
                        
                        <div class="weather-info">
                            <i class="fas fa-tint"></i> {{ forecast.precipitation_sum|round(1) }} mm
                        </div>
                      

                        <div class="weather-info">
                            <i class="fas fa-wind"></i> {{ forecast.wind_speed_max|round|int }} km/h
                        </div>
                    </div>
                    <div class="weather-advice">
                        {% if forecast.picto == 'sun' %}
                            <i class="fas fa-check-circle"></i> Parfait pour randonner
                         {% elif forecast.picto == 'partly_cloudy' %}
                            <i class="fas fa-check-circle"></i> Parfait pour randonner
                        {% elif forecast.picto == 'storm' %}
                            <i class="fas fa-exclamation-triangle"></i> √âviter les randos
                        {% elif forecast.picto == 'rain' or forecast.picto == 'snow' %}
                            <i class="fas fa-info-circle"></i> √âquipements conseill√©s
                        {% elif forecast.picto == 'fog' %}
                            <i class="fas fa-eye-slash"></i> Avec prudence
                        {% elif forecast.picto == 'cloud' %}
                            <i class="fas fa-cloud"></i> Conditions correctes
                        {% elif forecast.picto == 'indisponible' %}
                            <i class="fas fa-question-circle"></i> M√©t√©o indisponible
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p>Aucune donn√©e m√©t√©o disponible</p>
            {% endif %}
        </div>
    </div>

    <!-- Dur√©e du s√©jour -->
    <div class="duration-section">
        <h3>üìÖ Combien de jours voulez-vous rester ?</h3>
        <p>Consultez la m√©t√©o ci-dessus pour choisir la dur√©e id√©ale de votre s√©jour</p>
        <div class="duration-options">
            <div class="duration-card" data-days="1">
                <div class="duration-number">1</div>
                <div class="duration-label">jour</div>
                <div class="duration-desc">Escapade express</div>
            </div>
            <div class="duration-card active" data-days="2">
                <div class="duration-number">2</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Week-end parfait</div>
            </div>
            <div class="duration-card" data-days="3">
                <div class="duration-number">3</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Long week-end</div>
            </div>
            <div class="duration-card" data-days="7">
                <div class="duration-number">7</div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Semaine compl√®te</div>
            </div>
            <div class="duration-card" data-days="custom">
                <div class="duration-number">
                    <input type="number" id="customDays" min="1" max="30" placeholder="?">
                </div>
                <div class="duration-label">jours</div>
                <div class="duration-desc">Dur√©e personnalis√©e</div>
            </div>
        </div>
    </div>
</div>

<div class="planning-navigation">
    <div class="navigation-buttons navigation-right">
        <button id="planButton" class="btn btn-primary btn-large">
            Planifier ces 2 jours
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // ========================================
    // GESTION DE L'AUTHENTIFICATION JWT
    // ========================================
    
    document.addEventListener('DOMContentLoaded', function() {
        // R√©cup√©ration des √©l√©ments DOM pour l'authentification
        const loginForm = document.getElementById('loginForm');
        const userMenu = document.getElementById('userMenu');
        const stepperLoginForm = document.getElementById('stepperLoginForm');
        const stepperLoginError = document.getElementById('stepperLoginError');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // R√©cup√©ration des √©l√©ments DOM pour l'upload GPX
        const gpxUploadForm = document.getElementById('gpxUploadForm');
        const gpxFileInput = document.getElementById('gpxFileInput');
        const fileName = document.getElementById('fileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const gpxUploadError = document.getElementById('gpxUploadError');
        const gpxUploadSuccess = document.getElementById('gpxUploadSuccess');

        /**
         * V√©rifie si un token JWT est expir√©
         * D√©code le payload base64 et compare le timestamp d'expiration
         * @param {string} token - Le token JWT √† v√©rifier
         * @returns {boolean} - true si expir√© ou invalide, false sinon
         */
        function isJwtExpired(token) {
            if (!token) return true;
            try {
                const payload = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                if (!payload.exp) return true;
                // exp est en secondes depuis epoch
                const now = Math.floor(Date.now() / 1000);
                return payload.exp < now;
            } catch (e) {
                return true;
            }
        }

        // R√©cup√©ration du token et username depuis sessionStorage
        let token = sessionStorage.getItem('jwtToken');
        const username = sessionStorage.getItem('username');

        // Nettoyage automatique si le token est expir√©
        if (token && isJwtExpired(token)) {
            sessionStorage.removeItem('jwtToken');
            sessionStorage.removeItem('username');
            token = null;
        }

        // Affichage conditionnel : menu utilisateur OU formulaire de connexion
        if (token && username) {
            // Utilisateur connect√© : afficher le menu utilisateur avec upload GPX
            loginForm.style.display = 'none';
            userMenu.style.display = 'block';
            document.getElementById('userName').textContent = username;
        } else {
            // Utilisateur non connect√© : afficher le formulaire de connexion
            loginForm.style.display = 'block';
            userMenu.style.display = 'none';
        }
        
        // ========================================
        // GESTION DU FORMULAIRE DE CONNEXION
        // ========================================
        
        if (stepperLoginForm) {
            stepperLoginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                stepperLoginError.style.display = 'none';
                const login = document.getElementById('stepperLogin').value;
                const password = document.getElementById('stepperLoginPassword').value;
                
                try {
                    // Appel API de connexion via le proxy Flask
                    const response = await fetch('/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: login, password: password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // Succ√®s : stocker le token JWT et le username en sessionStorage
                        sessionStorage.setItem('jwtToken', data.token);
                        sessionStorage.setItem('username', data.username);
                        // Recharger la page pour afficher le menu utilisateur et les donn√©es filtr√©es par r√¥le
                        location.reload();
                    } else {
                        // √âchec : afficher le message d'erreur
                        stepperLoginError.textContent = data.message || 'Erreur de connexion';
                        stepperLoginError.style.display = 'block';
                    }
                } catch (err) {
                    console.error('Erreur connexion:', err);
                    stepperLoginError.textContent = 'Erreur r√©seau ou serveur';
                    stepperLoginError.style.display = 'block';
                }
            });
        }
        
        // ========================================
        // GESTION DE LA D√âCONNEXION
        // ========================================
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                // Supprimer le token et le username du sessionStorage
                sessionStorage.removeItem('jwtToken');
                sessionStorage.removeItem('username');
                // Recharger la page pour afficher le formulaire de connexion
                location.reload();
            });
        }
        
        // ========================================
        // GESTION DE L'UPLOAD GPX (Admin/Contributeur uniquement)
        // ========================================
        
        // Gestion de la s√©lection de fichier GPX
        if (gpxFileInput) {
            gpxFileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    fileName.textContent = this.files[0].name;
                    uploadBtn.disabled = false;
                } else {
                    fileName.textContent = '';
                    uploadBtn.disabled = true;
                }
            });
        }
        
        // Gestion de la soumission du formulaire d'upload GPX
        if (gpxUploadForm) {
            gpxUploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                // Masquer les messages d'erreur/succ√®s pr√©c√©dents
                gpxUploadError.style.display = 'none';
                gpxUploadSuccess.style.display = 'none';
                
                // Validation : fichier s√©lectionn√©
                const file = gpxFileInput.files[0];
                if (!file) {
                    gpxUploadError.textContent = 'Veuillez s√©lectionner un fichier';
                    gpxUploadError.style.display = 'block';
                    return;
                }
                
                // Validation : utilisateur authentifi√© (token JWT requis)
                if (!token) {
                    gpxUploadError.textContent = 'Vous devez √™tre connect√© pour uploader un fichier. Veuillez vous reconnecter.';
                    gpxUploadError.style.display = 'block';
                    return;
                }
                
                // Pr√©paration des donn√©es : cr√©ation d'un FormData avec le fichier GPX
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    // D√©sactiver le bouton pendant l'upload et afficher un indicateur de chargement
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Upload en cours...';
                    
                    // Appel API pour uploader le fichier GPX via le proxy Flask
                    // Le token JWT est envoy√© dans le header Authorization pour authentifier la requ√™te
                    const response = await fetch('/upload_gpx', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + token
                        },
                        body: formData
                    });
                    
                    // Traitement de la r√©ponse : gestion des diff√©rents types de contenu (JSON ou texte brut)
                    let data = null;
                    const contentType = response.headers.get('content-type') || '';
                    
                    if (contentType.includes('application/json')) {
                        // R√©ponse JSON : parser les donn√©es
                        try {
                            data = await response.json();
                        } catch (e) {
                            // Erreur de parsing JSON : afficher l'erreur et le contenu brut
                            console.error('Erreur parsing JSON:', e);
                            const text = await response.text();
                            gpxUploadError.textContent = `R√©ponse serveur non valide (status ${response.status}): ${text}`;
                            gpxUploadError.style.display = 'block';
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                            return;
                        }
                    } else {
                        // R√©ponse non-JSON (HTML ou texte brut)
                        const text = await response.text();
                        if (response.ok) {
                            // Succ√®s mais r√©ponse non-JSON : afficher le texte brut et recharger la page
                            gpxUploadSuccess.textContent = text;
                            gpxUploadSuccess.style.display = 'block';
                            gpxUploadForm.reset();
                            fileName.textContent = '';
                            uploadBtn.disabled = true;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                            setTimeout(() => { location.reload(); }, 2000);
                            return;
                        } else {
                            // Erreur serveur avec r√©ponse non-JSON : afficher le message d'erreur
                            gpxUploadError.textContent = `Erreur serveur (status ${response.status}): ${text}`;
                            gpxUploadError.style.display = 'block';
                            uploadBtn.disabled = false;
                            uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                            return;
                        }
                    }

                    // Traitement du succ√®s de l'upload
                    if (response.ok && data && data.success) {
                        // Construire le message de succ√®s avec la ville d√©tect√©e si disponible
                        const cityMsg = data.city ? ` - Ville d√©tect√©e : ${data.city}. Vous pouvez maintenant la s√©lectionner dans la liste pour voir les nouveaux r√©sultats.` : '';
                        gpxUploadSuccess.textContent = data.message + cityMsg;
                        gpxUploadSuccess.style.display = 'block';
                        
                        // R√©initialiser le formulaire d'upload
                        gpxUploadForm.reset();
                        fileName.textContent = '';
                        uploadBtn.disabled = true;
                        uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                        
                        // Si une ville a √©t√© d√©tect√©e, la s√©lectionner automatiquement dans le dropdown
                        if (data.city) {
                            const citySelect = document.getElementById('citySelect');
                            if (citySelect) {
                                // Parcourir les options pour trouver la ville correspondante
                                for (let i = 0; i < citySelect.options.length; i++) {
                                    if (citySelect.options[i].getAttribute('data-name') === data.city) {
                                        citySelect.selectedIndex = i;
                                        // D√©clencher l'√©v√©nement change pour mettre √† jour la carte et les statistiques
                                        citySelect.dispatchEvent(new Event('change'));
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        // Traitement de l'√©chec de l'upload
                        gpxUploadError.textContent = data.message || 'Erreur lors de l\'upload';
                        gpxUploadError.style.display = 'block';
                        uploadBtn.disabled = false;
                        uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                    }
                } catch (err) {
                    console.error('Erreur upload:', err);
                    gpxUploadError.textContent = 'Erreur r√©seau ou serveur';
                    gpxUploadError.style.display = 'block';
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Uploader le trac√©';
                }
            });
        }
        // ========================================
        // GESTION DE LA S√âLECTION DE VILLE (Carte et M√©t√©o)
        // ========================================
        
        const select = document.getElementById('citySelect');
        if (!select) return;
        
        // Variables pour la carte Leaflet
        let cityMap = null;
        let cityMarker = null;
        
        // Initialisation de la carte Leaflet sur la premi√®re ville s√©lectionn√©e
        const mapElement = document.getElementById('map');
        if (window.L && mapElement && !mapElement._leaflet_id) {
            // R√©cup√©rer les coordonn√©es de la ville s√©lectionn√©e par d√©faut
            const opt = select.options[select.selectedIndex];
            const lat = parseFloat(opt.getAttribute('data-lat'));
            const lon = parseFloat(opt.getAttribute('data-lon'));
            
            // Cr√©er la carte centr√©e sur la ville avec zoom niveau 12
            cityMap = L.map('map').setView([lat, lon], 12);
            // Ajouter les tuiles OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(cityMap);
            // Ajouter un marqueur sur la position de la ville
            cityMarker = L.marker([lat, lon]).addTo(cityMap);
        }
        
        // √âcouter le changement de ville dans le dropdown
        select.addEventListener('change', function() {
            const opt = select.options[select.selectedIndex];
            const cityName = opt.getAttribute('data-name');
            
            // Mise √† jour des informations de la ville (nom, d√©partement, statistiques)
            document.getElementById('cityName').textContent = cityName;
            const dept = opt.getAttribute('data-dept') || '';
            const country = opt.getAttribute('data-country') || '';
            document.getElementById('cityDept').textContent = dept + (country ? ' - ' + country : '');
            
            // Mise √† jour des statistiques : nombre de randonn√©es, spots nuit, POI
            document.getElementById('cityHikes').textContent = opt.getAttribute('data-hikes') + ' randonn√©es';
            document.getElementById('citySpots').textContent = opt.getAttribute('data-spots') + ' spots nuit';
            document.getElementById('cityServices').textContent = opt.getAttribute('data-poi') + " points d'int√©r√™t";
            
            // Mise √† jour du titre de la section m√©t√©o
            document.getElementById('weatherTitle').textContent = 'üå§Ô∏è M√©t√©o √† ' + cityName + ' - Prochains jours';
            
            // Mettre √† jour l'affichage de la m√©t√©o et de la carte
            updateWeatherDisplay(opt);
            updateMap(opt);
        });
        
        /**
         * Met √† jour l'affichage de la m√©t√©o pour la ville s√©lectionn√©e
         * Parse les donn√©es m√©t√©o depuis les attributs data-meteo de l'option
         * et g√©n√®re une grille de cartes m√©t√©o pour les 7 prochains jours
         * @param {HTMLOptionElement} option - L'option s√©lectionn√©e contenant les donn√©es m√©t√©o
         */
        function updateWeatherDisplay(option) {
            let meteoData = [];
            // Parser les donn√©es m√©t√©o JSON depuis l'attribut data-meteo
            try {
                meteoData = JSON.parse(option.getAttribute('data-meteo'));
            } catch (e) {
                console.error('Erreur parsing m√©t√©o:', e.message);
            }
            
            const weatherGrid = document.getElementById('weatherGrid');
            weatherGrid.innerHTML = '';
            
            if (meteoData && meteoData.length > 0) {
                // Tableaux pour formater les dates en fran√ßais
                const daysOfWeek = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                const months = ['janv', 'f√©vr', 'mars', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sept', 'oct', 'nov', 'd√©c'];
                
                // G√©n√©rer une carte m√©t√©o pour chaque jour de pr√©vision
                meteoData.forEach((forecast, index) => {
                    const date = new Date(forecast.date);
                    // Afficher "Aujourd'hui" pour le premier jour, sinon le jour de la semaine et la date
                    const dayName = index === 0 ? "Aujourd'hui" : 
                        `${daysOfWeek[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
                    
                    // D√©terminer la classe CSS selon le weather_code (bon/moyen/mauvais temps)
                    let weatherClass = 'good-weather';
                    if (forecast.weather_code >= 45 && forecast.weather_code <= 65) {
                        weatherClass = 'acceptable-weather';
                    } else if (forecast.weather_code > 65) {
                        weatherClass = 'bad-weather';
                    }
                    
                    // Mapper les pictogrammes m√©t√©o avec des conseils pour la randonn√©e
                    const adviceMap = {
                        'sun': { icon: 'fa-check-circle', text: 'Parfait pour randonner' },
                        'partly_cloudy': { icon: 'fa-check-circle', text: 'Parfait pour randonner' },
                        'storm': { icon: 'fa-exclamation-triangle', text: '√âviter les randos' },
                        'rain': { icon: 'fa-info-circle', text: '√âquipements conseill√©s' },
                        'snow': { icon: 'fa-info-circle', text: '√âquipements conseill√©s' },
                        'fog': { icon: 'fa-eye-slash', text: 'Avec prudence' },
                        'cloud': { icon: 'fa-cloud', text: 'Conditions correctes' },
                        'indisponible': { icon: 'fa-question-circle', text: 'M√©t√©o indisponible' }
                    };
                    const advice = adviceMap[forecast.picto] || adviceMap['indisponible'];
                    
                    // Cr√©er la carte m√©t√©o HTML pour ce jour
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'weather-day ' + weatherClass;
                    dayDiv.innerHTML = `
                        <div class="day-name">${dayName}</div>
                        <div class="weather-icon">
                            <img src="/static/images/wheather/${forecast.picto}.png" alt="${forecast.picto}" 
                                 style="width: 100%; max-width: 80px; height: auto;">
                        </div>
                        <div class="temperatures">
                            <span class="temp-max">${Math.round(forecast.temp_max)}¬∞</span>
                            <span class="temp-min">${Math.round(forecast.temp_min)}¬∞</span>
                        </div>
                        <div class="weather-details">
                            ${forecast.precipitation_sum > 0 ? 
                                `<div class="weather-info"><i class="fas fa-tint"></i> ${forecast.precipitation_sum.toFixed(1)} mm</div>` : ''}
                            ${forecast.wind_speed_max > 0 ? 
                                `<div class="weather-info"><i class="fas fa-wind"></i> ${Math.round(forecast.wind_speed_max)} km/h</div>` : ''}
                        </div>
                        <div class="weather-advice">
                            <i class="fas ${advice.icon}"></i> ${advice.text}
                        </div>
                    `;
                    // Ajouter la carte au conteneur grille
                    weatherGrid.appendChild(dayDiv);
                });
            } else {
                // Aucune donn√©e m√©t√©o disponible : afficher un message
                weatherGrid.innerHTML = '<p>Aucune donn√©e m√©t√©o disponible</p>';
            }
        }
        
        /**
         * Met √† jour la carte Leaflet avec les coordonn√©es de la ville s√©lectionn√©e
         * Centre la carte sur la nouvelle position et met √† jour le marqueur
         * @param {HTMLOptionElement} option - L'option s√©lectionn√©e contenant les coordonn√©es lat/lon
         */
        function updateMap(option) {
            if (!cityMap || !window.L) return;
            
            // R√©cup√©rer les coordonn√©es latitude/longitude depuis les attributs data
            const lat = parseFloat(option.getAttribute('data-lat'));
            const lon = parseFloat(option.getAttribute('data-lon'));
            
            if (!isNaN(lat) && !isNaN(lon)) {
                // Centrer la carte sur la nouvelle ville
                cityMap.setView([lat, lon], 12);
                // Supprimer l'ancien marqueur s'il existe
                if (cityMarker) {
                    cityMap.removeLayer(cityMarker);
                }
                // Cr√©er un nouveau marqueur sur la position de la ville
                cityMarker = L.marker([lat, lon]).addTo(cityMap);
            }
        }
        
        // ========================================
        // GESTION DE LA S√âLECTION DE LA DUR√âE DU S√âJOUR
        // ========================================
        
        let selectedDays = 2; // Dur√©e par d√©faut : 2 jours
        const durationCards = document.querySelectorAll('.duration-card');
        const planButton = document.getElementById('planButton');
        
        // √âcouter les clics sur les cartes de dur√©e
        durationCards.forEach(card => {
            card.addEventListener('click', function() {
                // Retirer la classe active de toutes les cartes
                durationCards.forEach(c => c.classList.remove('active'));
                
                // Ajouter la classe active √† la carte cliqu√©e
                this.classList.add('active');
                
                // R√©cup√©rer le nombre de jours s√©lectionn√©
                const days = this.getAttribute('data-days');
                
                if (days === 'custom') {
                    // Dur√©e personnalis√©e : focus sur l'input et √©couter les changements
                    const customInput = document.getElementById('customDays');
                    customInput.focus();
                    customInput.addEventListener('input', function() {
                        selectedDays = parseInt(this.value) || 2;
                        updatePlanButton();
                    });
                } else {
                    // Dur√©e pr√©d√©finie : mettre √† jour directement
                    selectedDays = parseInt(days);
                    updatePlanButton();
                }
            });
        });
        
        /**
         * Met √† jour le texte du bouton de planification selon la dur√©e s√©lectionn√©e
         * Affiche "jour" au singulier si 1 jour, "jours" au pluriel sinon
         */
        function updatePlanButton() {
            if (planButton) {
                const dayText = selectedDays === 1 ? 'jour' : 'jours';
                planButton.innerHTML = `Planifier ces ${selectedDays} ${dayText} <i class="fas fa-arrow-right"></i>`;
            }
        }
        
        // ========================================
        // CR√âATION DU PLAN ET NAVIGATION VERS √âTAPE 2
        // ========================================
        
        // √âcouter le clic sur le bouton de planification
        if (planButton) {
            planButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // R√©cup√©rer l'ID de la ville s√©lectionn√©e
                const selectedOption = select.options[select.selectedIndex];
                const cityId = selectedOption.value;
                
                // Stocker la ville et la dur√©e dans localStorage pour les √©tapes suivantes
                localStorage.setItem('selectedCityId', cityId);
                localStorage.setItem('selectedDays', selectedDays);
                
                // Lancer la cr√©ation du plan via API
                createPlan(cityId, selectedDays);
            });
        }
        
        /**
         * Appelle l'API create_plan pour cr√©er un nouveau plan de voyage
         * G√©n√®re un userToken invit√© si n√©cessaire et redirige vers l'√©tape 2
         * @param {number} cityId - L'ID de la ville s√©lectionn√©e
         * @param {number} days - La dur√©e du s√©jour en jours
         */
        async function createPlan(cityId, days) {
            try {
                // D√©sactiver le bouton et afficher un indicateur de chargement
                planButton.disabled = true;
                planButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation du plan...';

                // G√©n√©rer un userToken unique pour les utilisateurs non connect√©s (invit√©s)
                let userToken = localStorage.getItem('userToken');
                if (!userToken) {
                    // Utiliser crypto.randomUUID() si disponible, sinon g√©n√©rer un UUID v4 manuellement
                    userToken = crypto.randomUUID ? crypto.randomUUID() : ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
                    localStorage.setItem('userToken', userToken);
                }
                
                // R√©cup√©rer l'userId depuis localStorage (null si utilisateur non connect√©)
                const userId = localStorage.getItem('userId') ? parseInt(localStorage.getItem('userId')) : null;

                // Appel API pour cr√©er le plan avec les param√®tres s√©lectionn√©s
                const response = await fetch('/api/step1/create_plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        city_id: parseInt(cityId),
                        duration_days: days,
                        user_token: userToken,
                        user_id: userId
                    })
                });

                // V√©rifier le statut HTTP de la r√©ponse
                if (!response.ok) {
                    const text = await response.text();
                    console.error('create_plan response not ok', response.status, text);
                    throw new Error('Erreur lors de la cr√©ation du plan: ' + response.status);
                }

                // Parser la r√©ponse JSON de mani√®re robuste
                const text = await response.text();
                let data = null;
                try {
                    data = text ? JSON.parse(text) : null;
                } catch (e) {
                    console.error('Impossible de parser la r√©ponse JSON du create_plan:', e, 'raw:', text);
                    throw new Error('R√©ponse serveur invalide');
                }

                console.log('create_plan response data:', data);

                // Validation : v√©rifier que l'API a retourn√© un plan_id
                if (!data || !data.plan_id) {
                    console.error('Aucun plan_id retourn√© par create_plan:', data);
                    alert('La cr√©ation du plan a √©chou√© : r√©ponse inattendue du serveur.');
                    planButton.disabled = false;
                    updatePlanButton();
                    return;
                }

                // Stocker le plan_id dans localStorage pour les √©tapes suivantes
                localStorage.setItem('planId', data.plan_id);
                
                // Rediriger vers l'√©tape 2 (s√©lection des randonn√©es)
                window.location.href = "{{ url_for('step2') }}";

            } catch (error) {
                // Gestion des erreurs : afficher un message d'alerte et r√©activer le bouton
                console.error('Erreur:', error);
                alert('Erreur lors de la cr√©ation du plan: ' + error.message);
                planButton.disabled = false;
                updatePlanButton();
            }
        }
    });
</script>
{% endblock %}